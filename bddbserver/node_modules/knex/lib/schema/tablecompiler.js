/* eslint max-len:0 */

// Table Compiler
// -------
'use strict';

exports.__esModule = true;

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj['default'] = obj; return newObj; } }

var _helpers = require('./helpers');

var _helpers2 = require('../helpers');

var helpers = _interopRequireWildcard(_helpers2);

var _lodash = require('lodash');

function TableCompiler(client, tableBuilder) {
  this.client = client;
  this.method = tableBuilder._method;
  this.schemaNameRaw = tableBuilder._schemaName;
  this.tableNameRaw = tableBuilder._tableName;
  this.single = tableBuilder._single;
  this.grouped = _lodash.groupBy(tableBuilder._statements, 'grouping');
  this.formatter = client.formatter();
  this.sequence = [];
  this._formatting = client.config && client.config.formatting;
}

TableCompiler.prototype.pushQuery = _helpers.pushQuery;

TableCompiler.prototype.pushAdditional = _helpers.pushAdditional;

// Convert the tableCompiler toSQL
TableCompiler.prototype.toSQL = function () {
  this[this.method]();
  return this.sequence;
};

TableCompiler.prototype.lowerCase = true;

// Column Compilation
// -------

// If this is a table "creation", we need to first run through all
// of the columns to build them into a single string,
// and then run through anything else and push it to the query sequence.
TableCompiler.prototype.createAlterTableMethods = null;
TableCompiler.prototype.create = function (ifNot) {
  var columns = this.getColumns();
  var columnTypes = this.getColumnTypes(columns);
  if (this.createAlterTableMethods) {
    this.alterTableForCreate(columnTypes);
  }
  this.createQuery(columnTypes, ifNot);
  this.columnQueries(columns);
  delete this.single.comment;
  this.alterTable();
};

// Only create the table if it doesn't exist.
TableCompiler.prototype.createIfNot = function () {
  this.create(true);
};

// If we're altering the table, we need to one-by-one
// go through and handle each of the queries associated
// with altering the table's schema.
TableCompiler.prototype.alter = function () {
  var columns = this.getColumns();
  var columnTypes = this.getColumnTypes(columns);
  this.addColumns(columnTypes);
  this.columnQueries(columns);
  this.alterTable();
};

TableCompiler.prototype.foreign = function (foreignData) {
  if (foreignData.inTable && foreignData.references) {
    var keyName = this._indexCommand('foreign', this.tableNameRaw, foreignData.column);
    var column = this.formatter.columnize(foreignData.column);
    var references = this.formatter.columnize(foreignData.references);
    var inTable = this.formatter.wrap(foreignData.inTable);
    var onUpdate = foreignData.onUpdate ? (this.lowerCase ? ' on update ' : ' ON UPDATE ') + foreignData.onUpdate : '';
    var onDelete = foreignData.onDelete ? (this.lowerCase ? ' on delete ' : ' ON DELETE ') + foreignData.onDelete : '';
    if (this.lowerCase) {
      this.pushQuery((!this.forCreate ? 'alter table ' + this.tableName() + ' add ' : '') + 'constraint ' + keyName + ' ' + 'foreign key (' + column + ') references ' + inTable + ' (' + references + ')' + onUpdate + onDelete);
    } else {
      this.pushQuery((!this.forCreate ? 'ALTER TABLE ' + this.tableName() + ' ADD ' : '') + 'CONSTRAINT ' + keyName + ' ' + 'FOREIGN KEY (' + column + ') REFERENCES ' + inTable + ' (' + references + ')' + onUpdate + onDelete);
    }
  }
};

// Get all of the column sql & bindings individually for building the table queries.
TableCompiler.prototype.getColumnTypes = function (columns) {
  return _lodash.reduce(_lodash.map(columns, _lodash.first), function (memo, column) {
    memo.sql.push(column.sql);
    memo.bindings.concat(column.bindings);
    return memo;
  }, { sql: [], bindings: [] });
};

// Adds all of the additional queries from the "column"
TableCompiler.prototype.columnQueries = function (columns) {
  var queries = _lodash.reduce(_lodash.map(columns, _lodash.tail), function (memo, column) {
    if (!_lodash.isEmpty(column)) return memo.concat(column);
    return memo;
  }, []);
  for (var i = 0, l = queries.length; i < l; i++) {
    this.pushQuery(queries[i]);
  }
};

// Add a new column.
TableCompiler.prototype.addColumnsPrefix = 'add column ';

// All of the columns to "add" for the query
TableCompiler.prototype.addColumns = function (columns) {
  var _this = this;

  if (columns.sql.length > 0) {
    var columnSql = _lodash.map(columns.sql, function (column) {
      return _this.addColumnsPrefix + column;
    });
    this.pushQuery({
      sql: (this.lowerCase ? 'alter table ' : 'ALTER TABLE ') + this.tableName() + ' ' + columnSql.join(', '),
      bindings: columns.bindings
    });
  }
};

// Compile the columns as needed for the current create or alter table
TableCompiler.prototype.getColumns = function () {
  var _this2 = this;

  var columns = this.grouped.columns || [];
  return columns.map(function (column) {
    return _this2.client.columnCompiler(_this2, column.builder).toSQL();
  });
};

TableCompiler.prototype.tableName = function () {
  var name = this.schemaNameRaw ? this.schemaNameRaw + '.' + this.tableNameRaw : this.tableNameRaw;

  return this.formatter.wrap(name);
};

// Generate all of the alter column statements necessary for the query.
TableCompiler.prototype.alterTable = function () {
  var alterTable = this.grouped.alterTable || [];
  for (var i = 0, l = alterTable.length; i < l; i++) {
    var statement = alterTable[i];
    if (this[statement.method]) {
      this[statement.method].apply(this, statement.args);
    } else {
      helpers.error('Debug: ' + statement.method + ' does not exist');
    }
  }
  for (var item in this.single) {
    if (typeof this[item] === 'function') this[item](this.single[item]);
  }
};

TableCompiler.prototype.alterTableForCreate = function (columnTypes) {
  this.forCreate = true;
  var savedSequence = this.sequence;
  var alterTable = this.grouped.alterTable || [];
  this.grouped.alterTable = [];
  for (var i = 0, l = alterTable.length; i < l; i++) {
    var statement = alterTable[i];
    if (_lodash.indexOf(this.createAlterTableMethods, statement.method) < 0) {
      this.grouped.alterTable.push(statement);
      continue;
    }
    if (this[statement.method]) {
      this.sequence = [];
      this[statement.method].apply(this, statement.args);
      columnTypes.sql.push(this.sequence[0].sql);
    } else {
      helpers.error('Debug: ' + statement.method + ' does not exist');
    }
  }
  this.sequence = savedSequence;
  this.forCreate = false;
};

// Drop the index on the current table.
TableCompiler.prototype.dropIndex = function (value) {
  this.pushQuery('drop index' + value);
};

// Drop the unique
TableCompiler.prototype.dropUnique = TableCompiler.prototype.dropForeign = function () {
  throw new Error('Method implemented in the dialect driver');
};

TableCompiler.prototype.dropColumnPrefix = 'drop column ';
TableCompiler.prototype.dropColumn = function () {
  var _this3 = this;

  var columns = helpers.normalizeArr.apply(null, arguments);
  var drops = _lodash.map(_lodash.isArray(columns) ? columns : [columns], function (column) {
    return _this3.dropColumnPrefix + _this3.formatter.wrap(column);
  });
  this.pushQuery((this.lowerCase ? 'alter table ' : 'ALTER TABLE ') + this.tableName() + ' ' + drops.join(', '));
};

// If no name was specified for this index, we will create one using a basic
// convention of the table name, followed by the columns, followed by an
// index type, such as primary or index, which makes the index unique.
TableCompiler.prototype._indexCommand = function (type, tableName, columns) {
  if (!_lodash.isArray(columns)) columns = columns ? [columns] : [];
  var table = tableName.replace(/\.|-/g, '_');
  var indexName = (table + '_' + columns.join('_') + '_' + type).toLowerCase();
  return this.formatter.wrap(indexName);
};

exports['default'] = TableCompiler;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY2hlbWEvdGFibGVjb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O3VCQUkwQyxXQUFXOzt3QkFDNUIsWUFBWTs7SUFBekIsT0FBTzs7c0JBQzBELFFBQVE7O0FBRXJGLFNBQVMsYUFBYSxDQUFDLE1BQU0sRUFBRSxZQUFZLEVBQUU7QUFDM0MsTUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7QUFDcEIsTUFBSSxDQUFDLE1BQU0sR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDO0FBQ25DLE1BQUksQ0FBQyxhQUFhLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQztBQUM5QyxNQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7QUFDNUMsTUFBSSxDQUFDLE1BQU0sR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDO0FBQ25DLE1BQUksQ0FBQyxPQUFPLEdBQUcsZ0JBQVEsWUFBWSxDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUM3RCxNQUFJLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztBQUNwQyxNQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztBQUNuQixNQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUE7Q0FDN0Q7O0FBRUQsYUFBYSxDQUFDLFNBQVMsQ0FBQyxTQUFTLHFCQUFZLENBQUE7O0FBRTdDLGFBQWEsQ0FBQyxTQUFTLENBQUMsY0FBYywwQkFBaUIsQ0FBQTs7O0FBR3ZELGFBQWEsQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLFlBQVk7QUFDMUMsTUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO0FBQ3BCLFNBQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztDQUN0QixDQUFDOztBQUVGLGFBQWEsQ0FBQyxTQUFTLENBQUMsU0FBUyxHQUFHLElBQUks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QyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUEsQ0FBRSxXQUFXLEVBQUUsQ0FBQztBQUMvRSxTQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0NBQ3ZDLENBQUM7O3FCQUVhLGFBQWEiLCJmaWxlIjoidGFibGVjb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBtYXgtbGVuOjAgKi9cblxuLy8gVGFibGUgQ29tcGlsZXJcbi8vIC0tLS0tLS1cbmltcG9ydCB7IHB1c2hBZGRpdGlvbmFsLCBwdXNoUXVlcnkgfSBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0ICogYXMgaGVscGVycyBmcm9tICcuLi9oZWxwZXJzJztcbmltcG9ydCB7IGdyb3VwQnksIHJlZHVjZSwgbWFwLCBmaXJzdCwgdGFpbCwgaXNFbXB0eSwgaW5kZXhPZiwgaXNBcnJheSB9IGZyb20gJ2xvZGFzaCdcblxuZnVuY3Rpb24gVGFibGVDb21waWxlcihjbGllbnQsIHRhYmxlQnVpbGRlcikge1xuICB0aGlzLmNsaWVudCA9IGNsaWVudFxuICB0aGlzLm1ldGhvZCA9IHRhYmxlQnVpbGRlci5fbWV0aG9kO1xuICB0aGlzLnNjaGVtYU5hbWVSYXcgPSB0YWJsZUJ1aWxkZXIuX3NjaGVtYU5hbWU7XG4gIHRoaXMudGFibGVOYW1lUmF3ID0gdGFibGVCdWlsZGVyLl90YWJsZU5hbWU7XG4gIHRoaXMuc2luZ2xlID0gdGFibGVCdWlsZGVyLl9zaW5nbGU7XG4gIHRoaXMuZ3JvdXBlZCA9IGdyb3VwQnkodGFibGVCdWlsZGVyLl9zdGF0ZW1lbnRzLCAnZ3JvdXBpbmcnKTtcbiAgdGhpcy5mb3JtYXR0ZXIgPSBjbGllbnQuZm9ybWF0dGVyKCk7XG4gIHRoaXMuc2VxdWVuY2UgPSBbXTtcbiAgdGhpcy5fZm9ybWF0dGluZyA9IGNsaWVudC5jb25maWcgJiYgY2xpZW50LmNvbmZpZy5mb3JtYXR0aW5nXG59XG5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLnB1c2hRdWVyeSA9IHB1c2hRdWVyeVxuXG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5wdXNoQWRkaXRpb25hbCA9IHB1c2hBZGRpdGlvbmFsXG5cbi8vIENvbnZlcnQgdGhlIHRhYmxlQ29tcGlsZXIgdG9TUUxcblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLnRvU1FMID0gZnVuY3Rpb24gKCkge1xuICB0aGlzW3RoaXMubWV0aG9kXSgpO1xuICByZXR1cm4gdGhpcy5zZXF1ZW5jZTtcbn07XG5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmxvd2VyQ2FzZSA9IHRydWU7XG5cbi8vIENvbHVtbiBDb21waWxhdGlvblxuLy8gLS0tLS0tLVxuXG4vLyBJZiB0aGlzIGlzIGEgdGFibGUgXCJjcmVhdGlvblwiLCB3ZSBuZWVkIHRvIGZpcnN0IHJ1biB0aHJvdWdoIGFsbFxuLy8gb2YgdGhlIGNvbHVtbnMgdG8gYnVpbGQgdGhlbSBpbnRvIGEgc2luZ2xlIHN0cmluZyxcbi8vIGFuZCB0aGVuIHJ1biB0aHJvdWdoIGFueXRoaW5nIGVsc2UgYW5kIHB1c2ggaXQgdG8gdGhlIHF1ZXJ5IHNlcXVlbmNlLlxuVGFibGVDb21waWxlci5wcm90b3R5cGUuY3JlYXRlQWx0ZXJUYWJsZU1ldGhvZHMgPSBudWxsO1xuVGFibGVDb21waWxlci5wcm90b3R5cGUuY3JlYXRlID0gZnVuY3Rpb24gKGlmTm90KSB7XG4gIGNvbnN0IGNvbHVtbnMgPSB0aGlzLmdldENvbHVtbnMoKTtcbiAgY29uc3QgY29sdW1uVHlwZXMgPSB0aGlzLmdldENvbHVtblR5cGVzKGNvbHVtbnMpO1xuICBpZiAodGhpcy5jcmVhdGVBbHRlclRhYmxlTWV0aG9kcykge1xuICAgIHRoaXMuYWx0ZXJUYWJsZUZvckNyZWF0ZShjb2x1bW5UeXBlcyk7XG4gIH1cbiAgdGhpcy5jcmVhdGVRdWVyeShjb2x1bW5UeXBlcywgaWZOb3QpO1xuICB0aGlzLmNvbHVtblF1ZXJpZXMoY29sdW1ucyk7XG4gIGRlbGV0ZSB0aGlzLnNpbmdsZS5jb21tZW50O1xuICB0aGlzLmFsdGVyVGFibGUoKTtcbn07XG5cbi8vIE9ubHkgY3JlYXRlIHRoZSB0YWJsZSBpZiBpdCBkb2Vzbid0IGV4aXN0LlxuVGFibGVDb21waWxlci5wcm90b3R5cGUuY3JlYXRlSWZOb3QgPSBmdW5jdGlvbiAoKSB7XG4gIHRoaXMuY3JlYXRlKHRydWUpO1xufTtcblxuLy8gSWYgd2UncmUgYWx0ZXJpbmcgdGhlIHRhYmxlLCB3ZSBuZWVkIHRvIG9uZS1ieS1vbmVcbi8vIGdvIHRocm91Z2ggYW5kIGhhbmRsZSBlYWNoIG9mIHRoZSBxdWVyaWVzIGFzc29jaWF0ZWRcbi8vIHdpdGggYWx0ZXJpbmcgdGhlIHRhYmxlJ3Mgc2NoZW1hLlxuVGFibGVDb21waWxlci5wcm90b3R5cGUuYWx0ZXIgPSBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IGNvbHVtbnMgPSB0aGlzLmdldENvbHVtbnMoKTtcbiAgY29uc3QgY29sdW1uVHlwZXMgPSB0aGlzLmdldENvbHVtblR5cGVzKGNvbHVtbnMpO1xuICB0aGlzLmFkZENvbHVtbnMoY29sdW1uVHlwZXMpO1xuICB0aGlzLmNvbHVtblF1ZXJpZXMoY29sdW1ucyk7XG4gIHRoaXMuYWx0ZXJUYWJsZSgpO1xufTtcblxuVGFibGVDb21waWxlci5wcm90b3R5cGUuZm9yZWlnbiA9IGZ1bmN0aW9uIChmb3JlaWduRGF0YSkge1xuICBpZiAoZm9yZWlnbkRhdGEuaW5UYWJsZSAmJiBmb3JlaWduRGF0YS5yZWZlcmVuY2VzKSB7XG4gICAgY29uc3Qga2V5TmFtZSA9IHRoaXMuX2luZGV4Q29tbWFuZCgnZm9yZWlnbicsIHRoaXMudGFibGVOYW1lUmF3LCBmb3JlaWduRGF0YS5jb2x1bW4pO1xuICAgIGNvbnN0IGNvbHVtbiA9IHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShmb3JlaWduRGF0YS5jb2x1bW4pO1xuICAgIGNvbnN0IHJlZmVyZW5jZXMgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoZm9yZWlnbkRhdGEucmVmZXJlbmNlcyk7XG4gICAgY29uc3QgaW5UYWJsZSA9IHRoaXMuZm9ybWF0dGVyLndyYXAoZm9yZWlnbkRhdGEuaW5UYWJsZSk7XG4gICAgY29uc3Qgb25VcGRhdGUgPSBmb3JlaWduRGF0YS5vblVwZGF0ZSA/ICh0aGlzLmxvd2VyQ2FzZSA/ICcgb24gdXBkYXRlICcgOiAnIE9OIFVQREFURSAnKSArIGZvcmVpZ25EYXRhLm9uVXBkYXRlIDogJyc7XG4gICAgY29uc3Qgb25EZWxldGUgPSBmb3JlaWduRGF0YS5vbkRlbGV0ZSA/ICh0aGlzLmxvd2VyQ2FzZSA/ICcgb24gZGVsZXRlICcgOiAnIE9OIERFTEVURSAnKSArIGZvcmVpZ25EYXRhLm9uRGVsZXRlIDogJyc7XG4gICAgaWYgKHRoaXMubG93ZXJDYXNlKSB7XG4gICAgICB0aGlzLnB1c2hRdWVyeSgoIXRoaXMuZm9yQ3JlYXRlID8gYGFsdGVyIHRhYmxlICR7dGhpcy50YWJsZU5hbWUoKX0gYWRkIGAgOiAnJykgKyAnY29uc3RyYWludCAnICsga2V5TmFtZSArICcgJyArXG4gICAgICAgICdmb3JlaWduIGtleSAoJyArIGNvbHVtbiArICcpIHJlZmVyZW5jZXMgJyArIGluVGFibGUgKyAnICgnICsgcmVmZXJlbmNlcyArICcpJyArIG9uVXBkYXRlICsgb25EZWxldGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnB1c2hRdWVyeSgoIXRoaXMuZm9yQ3JlYXRlID8gYEFMVEVSIFRBQkxFICR7dGhpcy50YWJsZU5hbWUoKX0gQUREIGAgOiAnJykgKyAnQ09OU1RSQUlOVCAnICsga2V5TmFtZSArICcgJyArXG4gICAgICAgICdGT1JFSUdOIEtFWSAoJyArIGNvbHVtbiArICcpIFJFRkVSRU5DRVMgJyArIGluVGFibGUgKyAnICgnICsgcmVmZXJlbmNlcyArICcpJyArIG9uVXBkYXRlICsgb25EZWxldGUpO1xuICAgIH1cbiAgfVxufTtcblxuLy8gR2V0IGFsbCBvZiB0aGUgY29sdW1uIHNxbCAmIGJpbmRpbmdzIGluZGl2aWR1YWxseSBmb3IgYnVpbGRpbmcgdGhlIHRhYmxlIHF1ZXJpZXMuXG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5nZXRDb2x1bW5UeXBlcyA9IGNvbHVtbnMgPT5cbiAgcmVkdWNlKG1hcChjb2x1bW5zLCBmaXJzdCksIGZ1bmN0aW9uIChtZW1vLCBjb2x1bW4pIHtcbiAgICBtZW1vLnNxbC5wdXNoKGNvbHVtbi5zcWwpO1xuICAgIG1lbW8uYmluZGluZ3MuY29uY2F0KGNvbHVtbi5iaW5kaW5ncyk7XG4gICAgcmV0dXJuIG1lbW87XG4gIH0sIHsgc3FsOiBbXSwgYmluZGluZ3M6IFtdIH0pXG47XG5cbi8vIEFkZHMgYWxsIG9mIHRoZSBhZGRpdGlvbmFsIHF1ZXJpZXMgZnJvbSB0aGUgXCJjb2x1bW5cIlxuVGFibGVDb21waWxlci5wcm90b3R5cGUuY29sdW1uUXVlcmllcyA9IGZ1bmN0aW9uIChjb2x1bW5zKSB7XG4gIGNvbnN0IHF1ZXJpZXMgPSByZWR1Y2UobWFwKGNvbHVtbnMsIHRhaWwpLCBmdW5jdGlvbiAobWVtbywgY29sdW1uKSB7XG4gICAgaWYgKCFpc0VtcHR5KGNvbHVtbikpIHJldHVybiBtZW1vLmNvbmNhdChjb2x1bW4pO1xuICAgIHJldHVybiBtZW1vO1xuICB9LCBbXSk7XG4gIGZvciAobGV0IGkgPSAwLCBsID0gcXVlcmllcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICB0aGlzLnB1c2hRdWVyeShxdWVyaWVzW2ldKTtcbiAgfVxufTtcblxuLy8gQWRkIGEgbmV3IGNvbHVtbi5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmFkZENvbHVtbnNQcmVmaXggPSAnYWRkIGNvbHVtbiAnO1xuXG4vLyBBbGwgb2YgdGhlIGNvbHVtbnMgdG8gXCJhZGRcIiBmb3IgdGhlIHF1ZXJ5XG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5hZGRDb2x1bW5zID0gZnVuY3Rpb24gKGNvbHVtbnMpIHtcbiAgaWYgKGNvbHVtbnMuc3FsLmxlbmd0aCA+IDApIHtcbiAgICBjb25zdCBjb2x1bW5TcWwgPSBtYXAoY29sdW1ucy5zcWwsIChjb2x1bW4pID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmFkZENvbHVtbnNQcmVmaXggKyBjb2x1bW47XG4gICAgfSk7XG4gICAgdGhpcy5wdXNoUXVlcnkoe1xuICAgICAgc3FsOiAodGhpcy5sb3dlckNhc2UgPyAnYWx0ZXIgdGFibGUgJyA6ICdBTFRFUiBUQUJMRSAnKSArIHRoaXMudGFibGVOYW1lKCkgKyAnICcgKyBjb2x1bW5TcWwuam9pbignLCAnKSxcbiAgICAgIGJpbmRpbmdzOiBjb2x1bW5zLmJpbmRpbmdzXG4gICAgfSk7XG4gIH1cbn07XG5cbi8vIENvbXBpbGUgdGhlIGNvbHVtbnMgYXMgbmVlZGVkIGZvciB0aGUgY3VycmVudCBjcmVhdGUgb3IgYWx0ZXIgdGFibGVcblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtbnMgPSBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IGNvbHVtbnMgPSB0aGlzLmdyb3VwZWQuY29sdW1ucyB8fCBbXTtcbiAgcmV0dXJuIGNvbHVtbnMubWFwKGNvbHVtbiA9PlxuICAgIHRoaXMuY2xpZW50LmNvbHVtbkNvbXBpbGVyKHRoaXMsIGNvbHVtbi5idWlsZGVyKS50b1NRTCgpXG4gICk7XG59O1xuXG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS50YWJsZU5hbWUgPSBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IG5hbWUgPSB0aGlzLnNjaGVtYU5hbWVSYXcgP1xuICAgIGAke3RoaXMuc2NoZW1hTmFtZVJhd30uJHt0aGlzLnRhYmxlTmFtZVJhd31gXG4gICAgOiB0aGlzLnRhYmxlTmFtZVJhdztcblxuICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcChuYW1lKTtcbn07XG5cbi8vIEdlbmVyYXRlIGFsbCBvZiB0aGUgYWx0ZXIgY29sdW1uIHN0YXRlbWVudHMgbmVjZXNzYXJ5IGZvciB0aGUgcXVlcnkuXG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5hbHRlclRhYmxlID0gZnVuY3Rpb24gKCkge1xuICBjb25zdCBhbHRlclRhYmxlID0gdGhpcy5ncm91cGVkLmFsdGVyVGFibGUgfHwgW107XG4gIGZvciAobGV0IGkgPSAwLCBsID0gYWx0ZXJUYWJsZS5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICBjb25zdCBzdGF0ZW1lbnQgPSBhbHRlclRhYmxlW2ldO1xuICAgIGlmICh0aGlzW3N0YXRlbWVudC5tZXRob2RdKSB7XG4gICAgICB0aGlzW3N0YXRlbWVudC5tZXRob2RdLmFwcGx5KHRoaXMsIHN0YXRlbWVudC5hcmdzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaGVscGVycy5lcnJvcihgRGVidWc6ICR7c3RhdGVtZW50Lm1ldGhvZH0gZG9lcyBub3QgZXhpc3RgKTtcbiAgICB9XG4gIH1cbiAgZm9yIChjb25zdCBpdGVtIGluIHRoaXMuc2luZ2xlKSB7XG4gICAgaWYgKHR5cGVvZiB0aGlzW2l0ZW1dID09PSAnZnVuY3Rpb24nKSB0aGlzW2l0ZW1dKHRoaXMuc2luZ2xlW2l0ZW1dKTtcbiAgfVxufTtcblxuVGFibGVDb21waWxlci5wcm90b3R5cGUuYWx0ZXJUYWJsZUZvckNyZWF0ZSA9IGZ1bmN0aW9uIChjb2x1bW5UeXBlcykge1xuICB0aGlzLmZvckNyZWF0ZSA9IHRydWU7XG4gIGNvbnN0IHNhdmVkU2VxdWVuY2UgPSB0aGlzLnNlcXVlbmNlO1xuICBjb25zdCBhbHRlclRhYmxlID0gdGhpcy5ncm91cGVkLmFsdGVyVGFibGUgfHwgW107XG4gIHRoaXMuZ3JvdXBlZC5hbHRlclRhYmxlID0gW107XG4gIGZvciAobGV0IGkgPSAwLCBsID0gYWx0ZXJUYWJsZS5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICBjb25zdCBzdGF0ZW1lbnQgPSBhbHRlclRhYmxlW2ldO1xuICAgIGlmIChpbmRleE9mKHRoaXMuY3JlYXRlQWx0ZXJUYWJsZU1ldGhvZHMsIHN0YXRlbWVudC5tZXRob2QpIDwgMCkge1xuICAgICAgdGhpcy5ncm91cGVkLmFsdGVyVGFibGUucHVzaChzdGF0ZW1lbnQpO1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGlmICh0aGlzW3N0YXRlbWVudC5tZXRob2RdKSB7XG4gICAgICB0aGlzLnNlcXVlbmNlID0gW107XG4gICAgICB0aGlzW3N0YXRlbWVudC5tZXRob2RdLmFwcGx5KHRoaXMsIHN0YXRlbWVudC5hcmdzKTtcbiAgICAgIGNvbHVtblR5cGVzLnNxbC5wdXNoKHRoaXMuc2VxdWVuY2VbMF0uc3FsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaGVscGVycy5lcnJvcihgRGVidWc6ICR7c3RhdGVtZW50Lm1ldGhvZH0gZG9lcyBub3QgZXhpc3RgKTtcbiAgICB9XG4gIH1cbiAgdGhpcy5zZXF1ZW5jZSA9IHNhdmVkU2VxdWVuY2U7XG4gIHRoaXMuZm9yQ3JlYXRlID0gZmFsc2U7XG59O1xuXG5cbi8vIERyb3AgdGhlIGluZGV4IG9uIHRoZSBjdXJyZW50IHRhYmxlLlxuVGFibGVDb21waWxlci5wcm90b3R5cGUuZHJvcEluZGV4ID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gIHRoaXMucHVzaFF1ZXJ5KGBkcm9wIGluZGV4JHt2YWx1ZX1gKTtcbn07XG5cbi8vIERyb3AgdGhlIHVuaXF1ZVxuVGFibGVDb21waWxlci5wcm90b3R5cGUuZHJvcFVuaXF1ZSA9XG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5kcm9wRm9yZWlnbiA9IGZ1bmN0aW9uICgpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2QgaW1wbGVtZW50ZWQgaW4gdGhlIGRpYWxlY3QgZHJpdmVyJyk7XG59O1xuXG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5kcm9wQ29sdW1uUHJlZml4ID0gJ2Ryb3AgY29sdW1uICc7XG5UYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5kcm9wQ29sdW1uID0gZnVuY3Rpb24gKCkge1xuICBjb25zdCBjb2x1bW5zID0gaGVscGVycy5ub3JtYWxpemVBcnIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTtcbiAgY29uc3QgZHJvcHMgPSBtYXAoaXNBcnJheShjb2x1bW5zKSA/IGNvbHVtbnMgOiBbY29sdW1uc10sIChjb2x1bW4pID0+IHtcbiAgICByZXR1cm4gdGhpcy5kcm9wQ29sdW1uUHJlZml4ICsgdGhpcy5mb3JtYXR0ZXIud3JhcChjb2x1bW4pO1xuICB9KTtcbiAgdGhpcy5wdXNoUXVlcnkoXG4gICAgKHRoaXMubG93ZXJDYXNlID8gJ2FsdGVyIHRhYmxlICcgOiAnQUxURVIgVEFCTEUgJykgK1xuICAgIHRoaXMudGFibGVOYW1lKCkgKyAnICcgKyBkcm9wcy5qb2luKCcsICcpXG4gICk7XG59O1xuXG4vLyBJZiBubyBuYW1lIHdhcyBzcGVjaWZpZWQgZm9yIHRoaXMgaW5kZXgsIHdlIHdpbGwgY3JlYXRlIG9uZSB1c2luZyBhIGJhc2ljXG4vLyBjb252ZW50aW9uIG9mIHRoZSB0YWJsZSBuYW1lLCBmb2xsb3dlZCBieSB0aGUgY29sdW1ucywgZm9sbG93ZWQgYnkgYW5cbi8vIGluZGV4IHR5cGUsIHN1Y2ggYXMgcHJpbWFyeSBvciBpbmRleCwgd2hpY2ggbWFrZXMgdGhlIGluZGV4IHVuaXF1ZS5cblRhYmxlQ29tcGlsZXIucHJvdG90eXBlLl9pbmRleENvbW1hbmQgPSBmdW5jdGlvbiAodHlwZSwgdGFibGVOYW1lLCBjb2x1bW5zKSB7XG4gIGlmICghaXNBcnJheShjb2x1bW5zKSkgY29sdW1ucyA9IGNvbHVtbnMgPyBbY29sdW1uc10gOiBbXTtcbiAgY29uc3QgdGFibGUgPSB0YWJsZU5hbWUucmVwbGFjZSgvXFwufC0vZywgJ18nKTtcbiAgY29uc3QgaW5kZXhOYW1lID0gKHRhYmxlICsgJ18nICsgY29sdW1ucy5qb2luKCdfJykgKyAnXycgKyB0eXBlKS50b0xvd2VyQ2FzZSgpO1xuICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcChpbmRleE5hbWUpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgVGFibGVDb21waWxlcjtcbiJdfQ==