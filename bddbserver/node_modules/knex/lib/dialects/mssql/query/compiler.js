
// MSSQL Query Compiler
// ------
'use strict';

exports.__esModule = true;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _inherits = require('inherits');

var _inherits2 = _interopRequireDefault(_inherits);

var _queryCompiler = require('../../../query/compiler');

var _queryCompiler2 = _interopRequireDefault(_queryCompiler);

var _lodash = require('lodash');

function QueryCompiler_MSSQL(client, builder) {
  _queryCompiler2['default'].call(this, client, builder);
}
_inherits2['default'](QueryCompiler_MSSQL, _queryCompiler2['default']);

_lodash.assign(QueryCompiler_MSSQL.prototype, {

  _emptyInsertValue: 'default values',

  // Compiles an "insert" query, allowing for multiple
  // inserts using a single query statement.
  insert: function insert() {
    var insertValues = this.single.insert || [];
    var sql = 'insert into ' + this.tableName + ' ';
    var returning = this.single.returning;

    var returningSql = returning ? this._returning('insert', returning) + ' ' : '';

    if (Array.isArray(insertValues)) {
      if (insertValues.length === 0) {
        return '';
      }
    } else if (typeof insertValues === 'object' && _lodash.isEmpty(insertValues)) {
      return {
        sql: sql + returningSql + this._emptyInsertValue,
        returning: returning
      };
    }

    var insertData = this._prepInsert(insertValues);
    if (typeof insertData === 'string') {
      sql += insertData;
    } else {
      if (insertData.columns.length) {
        sql += '(' + this.formatter.columnize(insertData.columns);
        sql += ') ' + returningSql + 'values (';
        var i = -1;
        while (++i < insertData.values.length) {
          if (i !== 0) sql += '), (';
          sql += this.formatter.parameterize(insertData.values[i], this.client.valueForUndefined);
        }
        sql += ')';
      } else if (insertValues.length === 1 && insertValues[0]) {
        sql += returningSql + this._emptyInsertValue;
      } else {
        sql = '';
      }
    }
    return {
      sql: sql,
      returning: returning
    };
  },

  // Compiles an `update` query, allowing for a return value.
  update: function update() {
    var updates = this._prepUpdate(this.single.update);
    var join = this.join();
    var where = this.where();
    var order = this.order();
    var top = this.top();
    var returning = this.single.returning;

    return {
      sql: 'update ' + (top ? top + ' ' : '') + this.tableName + (join ? ' ' + join : '') + ' set ' + updates.join(', ') + (returning ? ' ' + this._returning('update', returning) : '') + (where ? ' ' + where : '') + (order ? ' ' + order : '') + (!returning ? this._returning('rowcount', '@@rowcount') : ''),
      returning: returning || '@@rowcount'
    };
  },

  // Compiles a `delete` query.
  del: function del() {
    // Make sure tableName is processed by the formatter first.
    var tableName = this.tableName;

    var wheres = this.where();
    var returning = this.single.returning;

    return {
      sql: 'delete from ' + tableName + (returning ? ' ' + this._returning('del', returning) : '') + (wheres ? ' ' + wheres : '') + (!returning ? this._returning('rowcount', '@@rowcount') : ''),
      returning: returning || '@@rowcount'
    };
  },

  // Compiles the columns in the query, specifying if an item was distinct.
  columns: function columns() {
    var distinct = false;
    if (this.onlyUnions()) return '';
    var columns = this.grouped.columns || [];
    var i = -1,
        sql = [];
    if (columns) {
      while (++i < columns.length) {
        var stmt = columns[i];
        if (stmt.distinct) distinct = true;
        if (stmt.type === 'aggregate') {
          sql.push(this.aggregate(stmt));
        } else if (stmt.value && stmt.value.length > 0) {
          sql.push(this.formatter.columnize(stmt.value));
        }
      }
    }
    if (sql.length === 0) sql = ['*'];
    var top = this.top();
    return 'select ' + (distinct ? 'distinct ' : '') + (top ? top + ' ' : '') + sql.join(', ') + (this.tableName ? ' from ' + this.tableName : '');
  },

  _returning: function _returning(method, value) {
    switch (method) {
      case 'update':
      case 'insert':
        return value ? 'output ' + this.formatter.columnizeWithPrefix('inserted.', value) : '';
      case 'del':
        return value ? 'output ' + this.formatter.columnizeWithPrefix('deleted.', value) : '';
      case 'rowcount':
        return value ? ';select @@rowcount' : '';
    }
  },

  // Compiles a `truncate` query.
  truncate: function truncate() {
    return 'truncate table ' + this.tableName;
  },

  forUpdate: function forUpdate() {
    return 'with (READCOMMITTEDLOCK)';
  },

  forShare: function forShare() {
    return 'with (NOLOCK)';
  },

  // Compiles a `columnInfo` query.
  columnInfo: function columnInfo() {
    var column = this.single.columnInfo;
    var sql = 'select * from information_schema.columns where table_name = ? and table_catalog = ?';
    var bindings = [this.single.table, this.client.database()];

    if (this.single.schema) {
      sql += ' and table_schema = ?';
      bindings.push(this.single.schema);
    } else {
      sql += ' and table_schema = \'dbo\'';
    }

    return {
      sql: sql,
      bindings: bindings,
      output: function output(resp) {
        var out = resp.reduce(function (columns, val) {
          columns[val.COLUMN_NAME] = {
            defaultValue: val.COLUMN_DEFAULT,
            type: val.DATA_TYPE,
            maxLength: val.CHARACTER_MAXIMUM_LENGTH,
            nullable: val.IS_NULLABLE === 'YES'
          };
          return columns;
        }, {});
        return column && out[column] || out;
      }
    };
  },

  top: function top() {
    var noLimit = !this.single.limit && this.single.limit !== 0;
    var noOffset = !this.single.offset;
    if (noLimit || !noOffset) return '';
    return 'top (' + this.formatter.parameter(this.single.limit) + ')';
  },

  limit: function limit() {
    return '';
  },

  offset: function offset() {
    var noLimit = !this.single.limit && this.single.limit !== 0;
    var noOffset = !this.single.offset;
    if (noOffset) return '';
    var offset = 'offset ' + (noOffset ? '0' : this.formatter.parameter(this.single.offset)) + ' rows';
    if (!noLimit) {
      offset += ' fetch next ' + this.formatter.parameter(this.single.limit) + ' rows only';
    }
    return offset;
  }

});

// Set the QueryBuilder & QueryCompiler on the client object,
// in case anyone wants to modify things to suit their own purposes.
exports['default'] = QueryCompiler_MSSQL;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9tc3NxbC9xdWVyeS9jb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7d0JBR3FCLFVBQVU7Ozs7NkJBQ0wseUJBQXlCOzs7O3NCQUVuQixRQUFROztBQUV4QyxTQUFTLG1CQUFtQixDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUU7QUFDNUMsNkJBQWMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUE7Q0FDMUM7QUFDRCxzQkFBUyxtQkFBbUIsNkJBQWdCLENBQUE7O0FBRTVDLGVBQU8sbUJBQW1CLENBQUMsU0FBUyxFQUFFOztBQUVwQyxtQkFBaUIsRUFBRSxnQkFBZ0I7Ozs7QUFJbkMsUUFBTSxFQUFBLGtCQUFHO0FBQ1AsUUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO0FBQzlDLFFBQUksR0FBRyxvQkFBa0IsSUFBSSxDQUFDLFNBQVMsTUFBRyxDQUFDO1FBQ25DLFNBQVMsR0FBSyxJQUFJLENBQUMsTUFBTSxDQUF6QixTQUFTOztBQUNqQixRQUFNLFlBQVksR0FBRyxTQUFTLEdBQzFCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxHQUFHLEdBQUcsR0FDMUMsRUFBRSxDQUFDOztBQUVQLFFBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRTtBQUMvQixVQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO0FBQzdCLGVBQU8sRUFBRSxDQUFBO09BQ1Y7S0FDRixNQUFNLElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxJQUFJLGdCQUFRLFlBQVksQ0FBQyxFQUFFO0FBQ3BFLGFBQU87QUFDTCxXQUFHLEVBQUUsR0FBRyxHQUFHLFlBQVksR0FBRyxJQUFJLENBQUMsaUJBQWlCO0FBQ2hELGlCQUFTLEVBQVQsU0FBUztPQUNWLENBQUM7S0FDSDs7QUFF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QUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztBQUNyQyxRQUFJLE9BQU8sSUFBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsQ0FBQztBQUNwQyxxQkFBZSxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFJO0dBQy9EOztBQUVELE9BQUssRUFBQSxpQkFBRztBQUNOLFdBQU8sRUFBRSxDQUFDO0dBQ1g7O0FBRUQsUUFBTSxFQUFBLGtCQUFHO0FBQ1AsUUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUM7QUFDOUQsUUFBTSxRQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztBQUNyQyxRQUFJLFFBQVEsRUFBRSxPQUFPLEVBQUUsQ0FBQztBQUN4QixRQUFJLE1BQU0sZ0JBQWEsUUFBUSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFBLFVBQU8sQ0FBQztBQUM1RixRQUFJLENBQUMsT0FBTyxFQUFFO0FBQ1osWUFBTSxxQkFBbUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsZUFBWSxDQUFDO0tBQ2xGO0FBQ0QsV0FBTyxNQUFNLENBQUM7R0FDZjs7Q0FFRixDQUFDLENBQUE7Ozs7cUJBSWEsbUJBQW1CIiwiZmlsZSI6ImNvbXBpbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBNU1NRTCBRdWVyeSBDb21waWxlclxuLy8gLS0tLS0tXG5pbXBvcnQgaW5oZXJpdHMgZnJvbSAnaW5oZXJpdHMnO1xuaW1wb3J0IFF1ZXJ5Q29tcGlsZXIgZnJvbSAnLi4vLi4vLi4vcXVlcnkvY29tcGlsZXInO1xuXG5pbXBvcnQgeyBhc3NpZ24sIGlzRW1wdHkgfSBmcm9tICdsb2Rhc2gnXG5cbmZ1bmN0aW9uIFF1ZXJ5Q29tcGlsZXJfTVNTUUwoY2xpZW50LCBidWlsZGVyKSB7XG4gIFF1ZXJ5Q29tcGlsZXIuY2FsbCh0aGlzLCBjbGllbnQsIGJ1aWxkZXIpXG59XG5pbmhlcml0cyhRdWVyeUNvbXBpbGVyX01TU1FMLCBRdWVyeUNvbXBpbGVyKVxuXG5hc3NpZ24oUXVlcnlDb21waWxlcl9NU1NRTC5wcm90b3R5cGUsIHtcblxuICBfZW1wdHlJbnNlcnRWYWx1ZTogJ2RlZmF1bHQgdmFsdWVzJyxcblxuICAvLyBDb21waWxlcyBhbiBcImluc2VydFwiIHF1ZXJ5LCBhbGxvd2luZyBmb3IgbXVsdGlwbGVcbiAgLy8gaW5zZXJ0cyB1c2luZyBhIHNpbmdsZSBxdWVyeSBzdGF0ZW1lbnQuXG4gIGluc2VydCgpIHtcbiAgICBjb25zdCBpbnNlcnRWYWx1ZXMgPSB0aGlzLnNpbmdsZS5pbnNlcnQgfHwgW107XG4gICAgbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMudGFibGVOYW1lfSBgO1xuICAgIGNvbnN0IHsgcmV0dXJuaW5nIH0gPSB0aGlzLnNpbmdsZTtcbiAgICBjb25zdCByZXR1cm5pbmdTcWwgPSByZXR1cm5pbmdcbiAgICAgID8gdGhpcy5fcmV0dXJuaW5nKCdpbnNlcnQnLCByZXR1cm5pbmcpICsgJyAnXG4gICAgICA6ICcnO1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoaW5zZXJ0VmFsdWVzKSkge1xuICAgICAgaWYgKGluc2VydFZhbHVlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuICcnXG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zZXJ0VmFsdWVzID09PSAnb2JqZWN0JyAmJiBpc0VtcHR5KGluc2VydFZhbHVlcykpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHNxbDogc3FsICsgcmV0dXJuaW5nU3FsICsgdGhpcy5fZW1wdHlJbnNlcnRWYWx1ZSxcbiAgICAgICAgcmV0dXJuaW5nXG4gICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IGluc2VydERhdGEgPSB0aGlzLl9wcmVwSW5zZXJ0KGluc2VydFZhbHVlcyk7XG4gICAgaWYgKHR5cGVvZiBpbnNlcnREYXRhID09PSAnc3RyaW5nJykge1xuICAgICAgc3FsICs9IGluc2VydERhdGE7XG4gICAgfSBlbHNlICB7XG4gICAgICBpZiAoaW5zZXJ0RGF0YS5jb2x1bW5zLmxlbmd0aCkge1xuICAgICAgICBzcWwgKz0gYCgke3RoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShpbnNlcnREYXRhLmNvbHVtbnMpfWBcbiAgICAgICAgc3FsICs9IGApICR7cmV0dXJuaW5nU3FsfXZhbHVlcyAoYFxuICAgICAgICBsZXQgaSA9IC0xXG4gICAgICAgIHdoaWxlICgrK2kgPCBpbnNlcnREYXRhLnZhbHVlcy5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAoaSAhPT0gMCkgc3FsICs9ICcpLCAoJ1xuICAgICAgICAgIHNxbCArPSB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXJpemUoXG4gICAgICAgICAgICBpbnNlcnREYXRhLnZhbHVlc1tpXSwgdGhpcy5jbGllbnQudmFsdWVGb3JVbmRlZmluZWRcbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgICAgc3FsICs9ICcpJztcbiAgICAgIH0gZWxzZSBpZiAoaW5zZXJ0VmFsdWVzLmxlbmd0aCA9PT0gMSAmJiBpbnNlcnRWYWx1ZXNbMF0pIHtcbiAgICAgICAgc3FsICs9IHJldHVybmluZ1NxbCArIHRoaXMuX2VtcHR5SW5zZXJ0VmFsdWVcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNxbCA9ICcnXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBzcWwsXG4gICAgICByZXR1cm5pbmdcbiAgICB9O1xuICB9LFxuXG4gIC8vIENvbXBpbGVzIGFuIGB1cGRhdGVgIHF1ZXJ5LCBhbGxvd2luZyBmb3IgYSByZXR1cm4gdmFsdWUuXG4gIHVwZGF0ZSgpIHtcbiAgICBjb25zdCB1cGRhdGVzID0gdGhpcy5fcHJlcFVwZGF0ZSh0aGlzLnNpbmdsZS51cGRhdGUpO1xuICAgIGNvbnN0IGpvaW4gPSB0aGlzLmpvaW4oKTtcbiAgICBjb25zdCB3aGVyZSA9IHRoaXMud2hlcmUoKTtcbiAgICBjb25zdCBvcmRlciA9IHRoaXMub3JkZXIoKTtcbiAgICBjb25zdCB0b3AgPSB0aGlzLnRvcCgpO1xuICAgIGNvbnN0IHsgcmV0dXJuaW5nIH0gPSB0aGlzLnNpbmdsZTtcbiAgICByZXR1cm4ge1xuICAgICAgc3FsOiBgdXBkYXRlICR7dG9wID8gdG9wICsgJyAnIDogJyd9JHt0aGlzLnRhYmxlTmFtZX1gICtcbiAgICAgICAgKGpvaW4gPyBgICR7am9pbn1gIDogJycpICtcbiAgICAgICAgJyBzZXQgJyArIHVwZGF0ZXMuam9pbignLCAnKSArXG4gICAgICAgIChyZXR1cm5pbmcgPyBgICR7dGhpcy5fcmV0dXJuaW5nKCd1cGRhdGUnLCByZXR1cm5pbmcpfWAgOiAnJykgK1xuICAgICAgICAod2hlcmUgPyBgICR7d2hlcmV9YCA6ICcnKSArXG4gICAgICAgIChvcmRlciA/IGAgJHtvcmRlcn1gIDogJycpICtcbiAgICAgICAgKCFyZXR1cm5pbmcgPyB0aGlzLl9yZXR1cm5pbmcoJ3Jvd2NvdW50JywgJ0BAcm93Y291bnQnKSA6ICcnKSxcbiAgICAgIHJldHVybmluZzogcmV0dXJuaW5nIHx8ICdAQHJvd2NvdW50J1xuICAgIH07XG4gIH0sXG5cbiAgLy8gQ29tcGlsZXMgYSBgZGVsZXRlYCBxdWVyeS5cbiAgZGVsKCkge1xuICAgIC8vIE1ha2Ugc3VyZSB0YWJsZU5hbWUgaXMgcHJvY2Vzc2VkIGJ5IHRoZSBmb3JtYXR0ZXIgZmlyc3QuXG4gICAgY29uc3QgeyB0YWJsZU5hbWUgfSA9IHRoaXM7XG4gICAgY29uc3Qgd2hlcmVzID0gdGhpcy53aGVyZSgpO1xuICAgIGNvbnN0IHsgcmV0dXJuaW5nIH0gPSB0aGlzLnNpbmdsZTtcbiAgICByZXR1cm4ge1xuICAgICAgc3FsOiBgZGVsZXRlIGZyb20gJHt0YWJsZU5hbWV9YCArXG4gICAgICAgIChyZXR1cm5pbmcgPyBgICR7dGhpcy5fcmV0dXJuaW5nKCdkZWwnLCByZXR1cm5pbmcpfWAgOiAnJykgK1xuICAgICAgICAod2hlcmVzID8gYCAke3doZXJlc31gIDogJycpICtcbiAgICAgICAgKCFyZXR1cm5pbmcgPyB0aGlzLl9yZXR1cm5pbmcoJ3Jvd2NvdW50JywgJ0BAcm93Y291bnQnKSA6ICcnKSxcbiAgICAgIHJldHVybmluZzogcmV0dXJuaW5nIHx8ICdAQHJvd2NvdW50J1xuICAgIH07XG4gIH0sXG5cblxuICAvLyBDb21waWxlcyB0aGUgY29sdW1ucyBpbiB0aGUgcXVlcnksIHNwZWNpZnlpbmcgaWYgYW4gaXRlbSB3YXMgZGlzdGluY3QuXG4gIGNvbHVtbnMoKSB7XG4gICAgbGV0IGRpc3RpbmN0ID0gZmFsc2U7XG4gICAgaWYgKHRoaXMub25seVVuaW9ucygpKSByZXR1cm4gJydcbiAgICBjb25zdCBjb2x1bW5zID0gdGhpcy5ncm91cGVkLmNvbHVtbnMgfHwgW11cbiAgICBsZXQgaSA9IC0xLCBzcWwgPSBbXTtcbiAgICBpZiAoY29sdW1ucykge1xuICAgICAgd2hpbGUgKCsraSA8IGNvbHVtbnMubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IHN0bXQgPSBjb2x1bW5zW2ldO1xuICAgICAgICBpZiAoc3RtdC5kaXN0aW5jdCkgZGlzdGluY3QgPSB0cnVlXG4gICAgICAgIGlmIChzdG10LnR5cGUgPT09ICdhZ2dyZWdhdGUnKSB7XG4gICAgICAgICAgc3FsLnB1c2godGhpcy5hZ2dyZWdhdGUoc3RtdCkpXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoc3RtdC52YWx1ZSAmJiBzdG10LnZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBzcWwucHVzaCh0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoc3RtdC52YWx1ZSkpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHNxbC5sZW5ndGggPT09IDApIHNxbCA9IFsnKiddO1xuICAgIGNvbnN0IHRvcCA9IHRoaXMudG9wKCk7XG4gICAgcmV0dXJuIGBzZWxlY3QgJHtkaXN0aW5jdCA/ICdkaXN0aW5jdCAnIDogJyd9YCArXG4gICAgICAodG9wID8gdG9wICsgJyAnIDogJycpICtcbiAgICAgIHNxbC5qb2luKCcsICcpICsgKHRoaXMudGFibGVOYW1lID8gYCBmcm9tICR7dGhpcy50YWJsZU5hbWV9YCA6ICcnKTtcbiAgfSxcblxuICBfcmV0dXJuaW5nKG1ldGhvZCwgdmFsdWUpIHtcbiAgICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgICAgY2FzZSAndXBkYXRlJzpcbiAgICAgIGNhc2UgJ2luc2VydCc6XG4gICAgICAgIHJldHVybiB2YWx1ZVxuICAgICAgICAgID8gYG91dHB1dCAke3RoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZVdpdGhQcmVmaXgoJ2luc2VydGVkLicsIHZhbHVlKX1gXG4gICAgICAgICAgOiAnJztcbiAgICAgIGNhc2UgJ2RlbCc6XG4gICAgICAgIHJldHVybiB2YWx1ZVxuICAgICAgICAgID8gYG91dHB1dCAke3RoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZVdpdGhQcmVmaXgoJ2RlbGV0ZWQuJywgdmFsdWUpfWBcbiAgICAgICAgICA6ICcnO1xuICAgICAgY2FzZSAncm93Y291bnQnOlxuICAgICAgICByZXR1cm4gdmFsdWVcbiAgICAgICAgICA/ICc7c2VsZWN0IEBAcm93Y291bnQnXG4gICAgICAgICAgOiAnJztcbiAgICB9XG4gIH0sXG5cbiAgLy8gQ29tcGlsZXMgYSBgdHJ1bmNhdGVgIHF1ZXJ5LlxuICB0cnVuY2F0ZSgpIHtcbiAgICByZXR1cm4gYHRydW5jYXRlIHRhYmxlICR7dGhpcy50YWJsZU5hbWV9YDtcbiAgfSxcblxuICBmb3JVcGRhdGUoKSB7XG4gICAgcmV0dXJuICd3aXRoIChSRUFEQ09NTUlUVEVETE9DSyknO1xuICB9LFxuXG4gIGZvclNoYXJlKCkge1xuICAgIHJldHVybiAnd2l0aCAoTk9MT0NLKSc7XG4gIH0sXG5cbiAgLy8gQ29tcGlsZXMgYSBgY29sdW1uSW5mb2AgcXVlcnkuXG4gIGNvbHVtbkluZm8oKSB7XG4gICAgY29uc3QgY29sdW1uID0gdGhpcy5zaW5nbGUuY29sdW1uSW5mbztcbiAgICBsZXQgc3FsID1gc2VsZWN0ICogZnJvbSBpbmZvcm1hdGlvbl9zY2hlbWEuY29sdW1ucyB3aGVyZSB0YWJsZV9uYW1lID0gPyBhbmQgdGFibGVfY2F0YWxvZyA9ID9gO1xuICAgIGNvbnN0IGJpbmRpbmdzID0gW3RoaXMuc2luZ2xlLnRhYmxlLCB0aGlzLmNsaWVudC5kYXRhYmFzZSgpXTtcblxuICAgIGlmICh0aGlzLnNpbmdsZS5zY2hlbWEpIHtcbiAgICAgIHNxbCArPSAnIGFuZCB0YWJsZV9zY2hlbWEgPSA/JztcbiAgICAgIGJpbmRpbmdzLnB1c2godGhpcy5zaW5nbGUuc2NoZW1hKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3FsICs9IGAgYW5kIHRhYmxlX3NjaGVtYSA9ICdkYm8nYDtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3FsLFxuICAgICAgYmluZGluZ3M6IGJpbmRpbmdzLFxuICAgICAgb3V0cHV0KHJlc3ApIHtcbiAgICAgICAgY29uc3Qgb3V0ID0gcmVzcC5yZWR1Y2UoZnVuY3Rpb24oY29sdW1ucywgdmFsKSB7XG4gICAgICAgICAgY29sdW1uc1t2YWwuQ09MVU1OX05BTUVdID0ge1xuICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2YWwuQ09MVU1OX0RFRkFVTFQsXG4gICAgICAgICAgICB0eXBlOiB2YWwuREFUQV9UWVBFLFxuICAgICAgICAgICAgbWF4TGVuZ3RoOiB2YWwuQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RILFxuICAgICAgICAgICAgbnVsbGFibGU6ICh2YWwuSVNfTlVMTEFCTEUgPT09ICdZRVMnKVxuICAgICAgICAgIH07XG4gICAgICAgICAgcmV0dXJuIGNvbHVtbnNcbiAgICAgICAgfSwge30pXG4gICAgICAgIHJldHVybiBjb2x1bW4gJiYgb3V0W2NvbHVtbl0gfHwgb3V0O1xuICAgICAgfVxuICAgIH07XG4gIH0sXG5cbiAgdG9wKCkge1xuICAgIGNvbnN0IG5vTGltaXQgPSAhdGhpcy5zaW5nbGUubGltaXQgJiYgdGhpcy5zaW5nbGUubGltaXQgIT09IDA7XG4gICAgY29uc3Qgbm9PZmZzZXQgPSAhdGhpcy5zaW5nbGUub2Zmc2V0O1xuICAgIGlmIChub0xpbWl0IHx8ICFub09mZnNldCkgcmV0dXJuICcnO1xuICAgIHJldHVybiBgdG9wICgke3RoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnNpbmdsZS5saW1pdCl9KWA7XG4gIH0sXG5cbiAgbGltaXQoKSB7XG4gICAgcmV0dXJuICcnO1xuICB9LFxuXG4gIG9mZnNldCgpIHtcbiAgICBjb25zdCBub0xpbWl0ID0gIXRoaXMuc2luZ2xlLmxpbWl0ICYmIHRoaXMuc2luZ2xlLmxpbWl0ICE9PSAwO1xuICAgIGNvbnN0IG5vT2Zmc2V0ID0gIXRoaXMuc2luZ2xlLm9mZnNldDtcbiAgICBpZiAobm9PZmZzZXQpIHJldHVybiAnJztcbiAgICBsZXQgb2Zmc2V0ID0gYG9mZnNldCAke25vT2Zmc2V0ID8gJzAnIDogdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKHRoaXMuc2luZ2xlLm9mZnNldCl9IHJvd3NgO1xuICAgIGlmICghbm9MaW1pdCkge1xuICAgICAgb2Zmc2V0ICs9IGAgZmV0Y2ggbmV4dCAke3RoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnNpbmdsZS5saW1pdCl9IHJvd3Mgb25seWA7XG4gICAgfVxuICAgIHJldHVybiBvZmZzZXQ7XG4gIH0sXG5cbn0pXG5cbi8vIFNldCB0aGUgUXVlcnlCdWlsZGVyICYgUXVlcnlDb21waWxlciBvbiB0aGUgY2xpZW50IG9iamVjdCxcbi8vIGluIGNhc2UgYW55b25lIHdhbnRzIHRvIG1vZGlmeSB0aGluZ3MgdG8gc3VpdCB0aGVpciBvd24gcHVycG9zZXMuXG5leHBvcnQgZGVmYXVsdCBRdWVyeUNvbXBpbGVyX01TU1FMO1xuIl19