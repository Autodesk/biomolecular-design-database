/* eslint max-len:0 no-console:0*/

// MySQL Table Builder & Compiler
// -------
'use strict';

exports.__esModule = true;

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj['default'] = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _inherits = require('inherits');

var _inherits2 = _interopRequireDefault(_inherits);

var _schemaTablecompiler = require('../../../schema/tablecompiler');

var _schemaTablecompiler2 = _interopRequireDefault(_schemaTablecompiler);

var _helpers = require('../../../helpers');

var helpers = _interopRequireWildcard(_helpers);

var _promise = require('../../../promise');

var _promise2 = _interopRequireDefault(_promise);

var _lodash = require('lodash');

// Table Compiler
// ------

function TableCompiler_MySQL() {
  _schemaTablecompiler2['default'].apply(this, arguments);
}
_inherits2['default'](TableCompiler_MySQL, _schemaTablecompiler2['default']);

_lodash.assign(TableCompiler_MySQL.prototype, {

  createQuery: function createQuery(columns, ifNot) {
    var createStatement = ifNot ? 'create table if not exists ' : 'create table ';
    var client = this.client;

    var conn = {};
    var sql = createStatement + this.tableName() + ' (' + columns.sql.join(', ') + ')';

    // Check if the connection settings are set.
    if (client.connectionSettings) {
      conn = client.connectionSettings;
    }

    var charset = this.single.charset || conn.charset || '';
    var collation = this.single.collate || conn.collate || '';
    var engine = this.single.engine || '';

    // var conn = builder.client.connectionSettings;
    if (charset) sql += ' default character set ' + charset;
    if (collation) sql += ' collate ' + collation;
    if (engine) sql += ' engine = ' + engine;

    if (this.single.comment) {
      var comment = this.single.comment || '';
      if (comment.length > 60) helpers.warn('The max length for a table comment is 60 characters');
      sql += ' comment = \'' + comment + '\'';
    }

    this.pushQuery(sql);
  },

  addColumnsPrefix: 'add ',

  dropColumnPrefix: 'drop ',

  // Compiles the comment on the table.
  comment: function comment(_comment) {
    this.pushQuery('alter table ' + this.tableName() + ' comment = \'' + _comment + '\'');
  },

  changeType: function changeType() {
    // alter table + table + ' modify ' + wrapped + '// type';
  },

  // Renames a column on the table.
  renameColumn: function renameColumn(from, to) {
    var compiler = this;
    var table = this.tableName();
    var wrapped = this.formatter.wrap(from) + ' ' + this.formatter.wrap(to);

    this.pushQuery({
      sql: 'show fields from ' + table + ' where field = ' + this.formatter.parameter(from),
      output: function output(resp) {
        var column = resp[0];
        var runner = this;
        return compiler.getFKRefs(runner).get(0).then(function (refs) {
          return _promise2['default']['try'](function () {
            if (!refs.length) {
              return;
            }
            return compiler.dropFKRefs(runner, refs);
          }).then(function () {
            var sql = 'alter table ' + table + ' change ' + wrapped + ' ' + column.Type;

            if (String(column.Null).toUpperCase() !== 'YES') {
              sql += ' NOT NULL';
            }
            if (column.Default !== void 0 && column.Default !== null) {
              sql += ' DEFAULT \'' + column.Default + '\'';
            }

            return runner.query({
              sql: sql
            });
          }).then(function () {
            if (!refs.length) {
              return;
            }
            return compiler.createFKRefs(runner, refs.map(function (ref) {
              if (ref.REFERENCED_COLUMN_NAME === from) {
                ref.REFERENCED_COLUMN_NAME = to;
              }
              if (ref.COLUMN_NAME === from) {
                ref.COLUMN_NAME = to;
              }
              return ref;
            }));
          });
        });
      }
    });
  },

  getFKRefs: function getFKRefs(runner) {
    var formatter = this.client.formatter();
    var sql = 'SELECT KCU.CONSTRAINT_NAME, KCU.TABLE_NAME, KCU.COLUMN_NAME, ' + '       KCU.REFERENCED_TABLE_NAME, KCU.REFERENCED_COLUMN_NAME, ' + '       RC.UPDATE_RULE, RC.DELETE_RULE ' + 'FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE AS KCU ' + 'JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS AS RC ' + '       USING(CONSTRAINT_NAME)' + 'WHERE KCU.REFERENCED_TABLE_NAME = ' + formatter.parameter(this.tableNameRaw) + ' ' + '  AND KCU.CONSTRAINT_SCHEMA = ' + formatter.parameter(this.client.database()) + ' ' + '  AND RC.CONSTRAINT_SCHEMA = ' + formatter.parameter(this.client.database());

    return runner.query({
      sql: sql,
      bindings: formatter.bindings
    });
  },

  dropFKRefs: function dropFKRefs(runner, refs) {
    var formatter = this.client.formatter();

    return _promise2['default'].all(refs.map(function (ref) {
      var constraintName = formatter.wrap(ref.CONSTRAINT_NAME);
      var tableName = formatter.wrap(ref.TABLE_NAME);
      return runner.query({
        sql: 'alter table ' + tableName + ' drop foreign key ' + constraintName
      });
    }));
  },
  createFKRefs: function createFKRefs(runner, refs) {
    var formatter = this.client.formatter();

    return _promise2['default'].all(refs.map(function (ref) {
      var tableName = formatter.wrap(ref.TABLE_NAME);
      var keyName = formatter.wrap(ref.CONSTRAINT_NAME);
      var column = formatter.columnize(ref.COLUMN_NAME);
      var references = formatter.columnize(ref.REFERENCED_COLUMN_NAME);
      var inTable = formatter.wrap(ref.REFERENCED_TABLE_NAME);
      var onUpdate = ' ON UPDATE ' + ref.UPDATE_RULE;
      var onDelete = ' ON DELETE ' + ref.DELETE_RULE;

      return runner.query({
        sql: 'alter table ' + tableName + ' add constraint ' + keyName + ' ' + 'foreign key (' + column + ') references ' + inTable + ' (' + references + ')' + onUpdate + onDelete
      });
    }));
  },
  index: function index(columns, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('index', this.tableNameRaw, columns);
    this.pushQuery('alter table ' + this.tableName() + ' add index ' + indexName + '(' + this.formatter.columnize(columns) + ')');
  },

  primary: function primary(columns, constraintName) {
    constraintName = constraintName ? this.formatter.wrap(constraintName) : this.formatter.wrap(this.tableNameRaw + '_pkey');
    this.pushQuery('alter table ' + this.tableName() + ' add primary key ' + constraintName + '(' + this.formatter.columnize(columns) + ')');
  },

  unique: function unique(columns, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('unique', this.tableNameRaw, columns);
    this.pushQuery('alter table ' + this.tableName() + ' add unique ' + indexName + '(' + this.formatter.columnize(columns) + ')');
  },

  // Compile a drop index command.
  dropIndex: function dropIndex(columns, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('index', this.tableNameRaw, columns);
    this.pushQuery('alter table ' + this.tableName() + ' drop index ' + indexName);
  },

  // Compile a drop foreign key command.
  dropForeign: function dropForeign(columns, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('foreign', this.tableNameRaw, columns);
    this.pushQuery('alter table ' + this.tableName() + ' drop foreign key ' + indexName);
  },

  // Compile a drop primary key command.
  dropPrimary: function dropPrimary() {
    this.pushQuery('alter table ' + this.tableName() + ' drop primary key');
  },

  // Compile a drop unique key command.
  dropUnique: function dropUnique(column, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('unique', this.tableNameRaw, column);
    this.pushQuery('alter table ' + this.tableName() + ' drop index ' + indexName);
  }

});

exports['default'] = TableCompiler_MySQL;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9teXNxbC9zY2hlbWEvdGFibGVjb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7d0JBSXFCLFVBQVU7Ozs7bUNBQ0wsK0JBQStCOzs7O3VCQUNoQyxrQkFBa0I7O0lBQS9CLE9BQU87O3VCQUNDLGtCQUFrQjs7OztzQkFFZixRQUFROzs7OztBQUsvQixTQUFTLG1CQUFtQixHQUFHO0FBQzdCLG1DQUFjLEtBQUssQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7Q0FDdEM7QUFDRCxzQkFBUyxtQkFBbUIsbUNBQWdCLENBQUM7O0FBRTdDLGVBQU8sbUJBQW1CLENBQUMsU0FBUyxFQUFFOztBQUVwQyxhQUFXLEVBQUEscUJBQUMsT0FBTyxFQUFFLEtBQUssRUFBRTtBQUMxQixRQUFNLGVBQWUsR0FBRyxLQUFLLEdBQUcsNkJBQTZCLEdBQUcsZUFBZSxDQUFDO1FBQ3hFLE1BQU0sR0FBSyxJQUFJLENBQWYsTUFBTTs7QUFDZCxRQUFJLElBQUksR0FBRyxFQUFFLENBQUM7QUFDZCxRQUFJLEdBQUcsR0FBRyxlQUFlLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUM7OztBQUduRixRQUFJLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRTtBQUM3QixVQUFJLEdBQUcsTUFBTSxDQUFDLGtCQUFrQixDQUFDO0tBQ2xDOztBQUVELFFBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO0FBQzFELFFBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO0FBQzVELFFBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFLLEVBQUUsQ0FBQzs7O0FBR3pDLFFBQUksT0FBTyxFQUFJLEdBQUcsZ0NBQThCLE9BQU8sQUFBRSxDQUFDO0FBQzFELFFBQUksU0FBUyxFQUFFLEdBQUcsa0JBQWdCLFNBQVMsQUFBRSxDQUFDO0FBQzlDLFFBQUksTUFBTSxFQUFLLEdBQUcsbUJBQWlCLE1BQU0sQUFBRSxDQUFDOztBQUU1QyxRQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO0FBQ3ZCLFVBQU0sT0FBTyxHQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxJQUFJLEVBQUUsQUFBQyxDQUFDO0FBQzVDLFVBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxFQUFFLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO0FBQzdGLFNBQUcsc0JBQW1CLE9BQU8sT0FBRyxDQUFDO0tBQ2xDOztBQUVELFFBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7R0FDckI7O0FBRUQsa0JBQWdCLEVBQUUsTUFBTTs7QUFFeEIsa0JBQWdCLEVBQUUsT0FBTzs7O0FBR3pCLFNBQU8sRUFBQSxpQkFBQyxRQUFPLEVBQUU7QUFDZixRQUFJLENBQUMsU0FBUyxrQkFBZ0IsSUFBSSxDQUFDLFNBQVMsRUFBRSxxQkFBZSxRQUFPLFFBQUksQ0FBQztHQUMxRTs7QUFFRCxZQUFVLEVBQUEsc0JBQUc7O0dBRVo7OztBQUdELGNBQVksRUFBQSxzQkFBQyxJQUFJLEVBQUUsRUFBRSxFQUFFO0FBQ3JCLFFBQU0sUUFBUSxHQUFHLElBQUksQ0FBQztBQUN0QixRQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDL0IsUUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDOztBQUUxRSxRQUFJLENBQUMsU0FBUyxDQUFDO0FBQ2IsU0FBRyxFQUFFLHNCQUFvQixLQUFLLHVCQUM1QixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7QUFDaEMsWUFBTSxFQUFBLGdCQUFDLElBQUksRUFBRTtBQUNYLFlBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2QixZQUFNLE1BQU0sR0FBRyxJQUFJLENBQUM7QUFDcEIsZUFBTyxRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FDckMsSUFBSSxDQUFDLFVBQUEsSUFBSTtpQkFDUiwyQkFBVyxDQUFDLFlBQVk7QUFDdEIsZ0JBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO0FBQUUscUJBQU87YUFBRTtBQUM3QixtQkFBTyxRQUFRLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztXQUMxQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVk7QUFDbEIsZ0JBQUksR0FBRyxvQkFBa0IsS0FBSyxnQkFBVyxPQUFPLFNBQUksTUFBTSxDQUFDLElBQUksQUFBRSxDQUFDOztBQUVsRSxnQkFBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLFdBQVcsRUFBRSxLQUFLLEtBQUssRUFBRTtBQUM5QyxpQkFBRyxlQUFlLENBQUE7YUFDbkI7QUFDRCxnQkFBRyxNQUFNLENBQUMsT0FBTyxLQUFLLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEtBQUssSUFBSSxFQUFFO0FBQ3ZELGlCQUFHLG9CQUFpQixNQUFNLENBQUMsT0FBTyxPQUFHLENBQUE7YUFDdEM7O0FBRUQsbUJBQU8sTUFBTSxDQUFDLEtBQUssQ0FBQztBQUNsQixpQkFBRyxFQUFILEdBQUc7YUFDSixDQUFDLENBQUM7V0FDSixDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVk7QUFDbEIsZ0JBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO0FBQUUscUJBQU87YUFBRTtBQUM3QixtQkFBTyxRQUFRLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxFQUFFO0FBQzNELGtCQUFJLEdBQUcsQ0FBQyxzQkFBc0IsS0FBSyxJQUFJLEVBQUU7QUFDdkMsbUJBQUcsQ0FBQyxzQkFBc0IsR0FBRyxFQUFFLENBQUM7ZUFDakM7QUFDRCxrQkFBSSxHQUFHLENBQUMsV0FBVyxLQUFLLElBQUksRUFBRTtBQUM1QixtQkFBRyxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7ZUFDdEI7QUFDRCxxQkFBTyxHQUFHLENBQUM7YUFDWixDQUFDLENBQUMsQ0FBQztXQUNMLENBQUM7U0FBQSxDQUNILENBQUM7T0FDTDtLQUNGLENBQUMsQ0FBQztHQUNKOztBQUVELFdBQVMsRUFBQyxtQkFBQyxNQUFNLEVBQUU7QUFDakIsUUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztBQUMxQyxRQUFNLEdBQUcsR0FBRywrREFBK0QsR0FDakUsZ0VBQWdFLEdBQ2hFLHdDQUF3QyxHQUN4QyxrREFBa0QsR0FDbEQsd0RBQXdELEdBQ3hELCtCQUErQixHQUMvQixvQ0FBb0MsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxHQUFHLEdBQ25GLGdDQUFnQyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FDcEYsK0JBQStCLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7O0FBRXhGLFdBQU8sTUFBTSxDQUFDLEtBQUssQ0FBQztBQUNsQixTQUFHLEVBQUgsR0FBRztBQUNILGNBQVEsRUFBRSxTQUFTLENBQUMsUUFBUTtLQUM3QixDQUFDLENBQUM7R0FDSjs7QUFFRCxZQUFVLEVBQUMsb0JBQUMsTUFBTSxFQUFFLElBQUksRUFBRTtBQUN4QixRQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDOztBQUUxQyxXQUFPLHFCQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxFQUFFO0FBQ3pDLFVBQU0sY0FBYyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQzNELFVBQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ2pELGFBQU8sTUFBTSxDQUFDLEtBQUssQ0FBQztBQUNsQixXQUFHLG1CQUFpQixTQUFTLDBCQUFxQixjQUFjLEFBQUU7T0FDbkUsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDLENBQUM7R0FDTDtBQUNELGNBQVksRUFBQyxzQkFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFO0FBQzFCLFFBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7O0FBRTFDLFdBQU8scUJBQVEsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLEVBQUU7QUFDekMsVUFBTSxTQUFTLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDakQsVUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDcEQsVUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDcEQsVUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNuRSxVQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQzFELFVBQU0sUUFBUSxtQkFBaUIsR0FBRyxDQUFDLFdBQVcsQUFBRSxDQUFDO0FBQ2pELFVBQU0sUUFBUSxtQkFBaUIsR0FBRyxDQUFDLFdBQVcsQUFBRSxDQUFDOztBQUVqRCxhQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUM7QUFDbEIsV0FBRyxFQUFFLGlCQUFlLFNBQVMsd0JBQW1CLE9BQU8sU0FDckQsZUFBZSxHQUFHLE1BQU0sR0FBRyxlQUFlLEdBQUcsT0FBTyxHQUFHLElBQUksR0FBRyxVQUFVLEdBQUcsR0FBRyxHQUFHLFFBQVEsR0FBRyxRQUFRO09BQ3ZHLENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQyxDQUFDO0dBQ0w7QUFDRCxPQUFLLEVBQUEsZUFBQyxPQUFPLEVBQUUsU0FBUyxFQUFFO0FBQ3hCLGFBQVMsR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNqSCxRQUFJLENBQUMsU0FBUyxrQkFBZ0IsSUFBSSxDQUFDLFNBQVMsRUFBRSxtQkFBYyxTQUFTLFNBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQUksQ0FBQztHQUNoSDs7QUFFRCxTQUFPLEVBQUEsaUJBQUMsT0FBTyxFQUFFLGNBQWMsRUFBRTtBQUMvQixrQkFBYyxHQUFHLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBSSxJQUFJLENBQUMsWUFBWSxXQUFRLENBQUM7QUFDekgsUUFBSSxDQUFDLFNBQVMsa0JBQWdCLElBQUksQ0FBQyxTQUFTLEVBQUUseUJBQW9CLGNBQWMsU0FBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBSSxDQUFDO0dBQzNIOztBQUVELFFBQU0sRUFBQSxnQkFBQyxPQUFPLEVBQUUsU0FBUyxFQUFFO0FBQ3pCLGFBQVMsR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNsSCxRQUFJLENBQUMsU0FBUyxrQkFBZ0IsSUFBSSxDQUFDLFNBQVMsRUFBRSxvQkFBZSxTQUFTLFNBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQUksQ0FBQztHQUNqSDs7O0FBR0QsV0FBUyxFQUFBLG1CQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUU7QUFDNUIsYUFBUyxHQUFHLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ2pILFFBQUksQ0FBQyxTQUFTLGtCQUFnQixJQUFJLENBQUMsU0FBUyxFQUFFLG9CQUFlLFNBQVMsQ0FBRyxDQUFDO0dBQzNFOzs7QUFHRCxhQUFXLEVBQUEscUJBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRTtBQUM5QixhQUFTLEdBQUcsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDbkgsUUFBSSxDQUFDLFNBQVMsa0JBQWdCLElBQUksQ0FBQyxTQUFTLEVBQUUsMEJBQXFCLFNBQVMsQ0FBRyxDQUFDO0dBQ2pGOzs7QUFHRCxhQUFXLEVBQUEsdUJBQUc7QUFDWixRQUFJLENBQUMsU0FBUyxrQkFBZ0IsSUFBSSxDQUFDLFNBQVMsRUFBRSx1QkFBb0IsQ0FBQztHQUNwRTs7O0FBR0QsWUFBVSxFQUFBLG9CQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUU7QUFDNUIsYUFBUyxHQUFHLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ2pILFFBQUksQ0FBQyxTQUFTLGtCQUFnQixJQUFJLENBQUMsU0FBUyxFQUFFLG9CQUFlLFNBQVMsQ0FBRyxDQUFDO0dBQzNFOztDQUVGLENBQUMsQ0FBQTs7cUJBRWEsbUJBQW1CIiwiZmlsZSI6InRhYmxlY29tcGlsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQgbWF4LWxlbjowIG5vLWNvbnNvbGU6MCovXG5cbi8vIE15U1FMIFRhYmxlIEJ1aWxkZXIgJiBDb21waWxlclxuLy8gLS0tLS0tLVxuaW1wb3J0IGluaGVyaXRzIGZyb20gJ2luaGVyaXRzJztcbmltcG9ydCBUYWJsZUNvbXBpbGVyIGZyb20gJy4uLy4uLy4uL3NjaGVtYS90YWJsZWNvbXBpbGVyJztcbmltcG9ydCAqIGFzIGhlbHBlcnMgZnJvbSAnLi4vLi4vLi4vaGVscGVycyc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICcuLi8uLi8uLi9wcm9taXNlJztcblxuaW1wb3J0IHsgYXNzaWduIH0gZnJvbSAnbG9kYXNoJ1xuXG4vLyBUYWJsZSBDb21waWxlclxuLy8gLS0tLS0tXG5cbmZ1bmN0aW9uIFRhYmxlQ29tcGlsZXJfTXlTUUwoKSB7XG4gIFRhYmxlQ29tcGlsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn1cbmluaGVyaXRzKFRhYmxlQ29tcGlsZXJfTXlTUUwsIFRhYmxlQ29tcGlsZXIpO1xuXG5hc3NpZ24oVGFibGVDb21waWxlcl9NeVNRTC5wcm90b3R5cGUsIHtcblxuICBjcmVhdGVRdWVyeShjb2x1bW5zLCBpZk5vdCkge1xuICAgIGNvbnN0IGNyZWF0ZVN0YXRlbWVudCA9IGlmTm90ID8gJ2NyZWF0ZSB0YWJsZSBpZiBub3QgZXhpc3RzICcgOiAnY3JlYXRlIHRhYmxlICc7XG4gICAgY29uc3QgeyBjbGllbnQgfSA9IHRoaXM7XG4gICAgbGV0IGNvbm4gPSB7fTtcbiAgICBsZXQgc3FsID0gY3JlYXRlU3RhdGVtZW50ICsgdGhpcy50YWJsZU5hbWUoKSArICcgKCcgKyBjb2x1bW5zLnNxbC5qb2luKCcsICcpICsgJyknO1xuXG4gICAgLy8gQ2hlY2sgaWYgdGhlIGNvbm5lY3Rpb24gc2V0dGluZ3MgYXJlIHNldC5cbiAgICBpZiAoY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5ncykge1xuICAgICAgY29ubiA9IGNsaWVudC5jb25uZWN0aW9uU2V0dGluZ3M7XG4gICAgfVxuXG4gICAgY29uc3QgY2hhcnNldCA9IHRoaXMuc2luZ2xlLmNoYXJzZXQgfHwgY29ubi5jaGFyc2V0IHx8ICcnO1xuICAgIGNvbnN0IGNvbGxhdGlvbiA9IHRoaXMuc2luZ2xlLmNvbGxhdGUgfHwgY29ubi5jb2xsYXRlIHx8ICcnO1xuICAgIGNvbnN0IGVuZ2luZSA9IHRoaXMuc2luZ2xlLmVuZ2luZSAgfHwgJyc7XG5cbiAgICAvLyB2YXIgY29ubiA9IGJ1aWxkZXIuY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5ncztcbiAgICBpZiAoY2hhcnNldCkgICBzcWwgKz0gYCBkZWZhdWx0IGNoYXJhY3RlciBzZXQgJHtjaGFyc2V0fWA7XG4gICAgaWYgKGNvbGxhdGlvbikgc3FsICs9IGAgY29sbGF0ZSAke2NvbGxhdGlvbn1gO1xuICAgIGlmIChlbmdpbmUpICAgIHNxbCArPSBgIGVuZ2luZSA9ICR7ZW5naW5lfWA7XG5cbiAgICBpZiAodGhpcy5zaW5nbGUuY29tbWVudCkge1xuICAgICAgY29uc3QgY29tbWVudCA9ICh0aGlzLnNpbmdsZS5jb21tZW50IHx8ICcnKTtcbiAgICAgIGlmIChjb21tZW50Lmxlbmd0aCA+IDYwKSBoZWxwZXJzLndhcm4oJ1RoZSBtYXggbGVuZ3RoIGZvciBhIHRhYmxlIGNvbW1lbnQgaXMgNjAgY2hhcmFjdGVycycpO1xuICAgICAgc3FsICs9IGAgY29tbWVudCA9ICcke2NvbW1lbnR9J2A7XG4gICAgfVxuXG4gICAgdGhpcy5wdXNoUXVlcnkoc3FsKTtcbiAgfSxcblxuICBhZGRDb2x1bW5zUHJlZml4OiAnYWRkICcsXG5cbiAgZHJvcENvbHVtblByZWZpeDogJ2Ryb3AgJyxcblxuICAvLyBDb21waWxlcyB0aGUgY29tbWVudCBvbiB0aGUgdGFibGUuXG4gIGNvbW1lbnQoY29tbWVudCkge1xuICAgIHRoaXMucHVzaFF1ZXJ5KGBhbHRlciB0YWJsZSAke3RoaXMudGFibGVOYW1lKCl9IGNvbW1lbnQgPSAnJHtjb21tZW50fSdgKTtcbiAgfSxcblxuICBjaGFuZ2VUeXBlKCkge1xuICAgIC8vIGFsdGVyIHRhYmxlICsgdGFibGUgKyAnIG1vZGlmeSAnICsgd3JhcHBlZCArICcvLyB0eXBlJztcbiAgfSxcblxuICAvLyBSZW5hbWVzIGEgY29sdW1uIG9uIHRoZSB0YWJsZS5cbiAgcmVuYW1lQ29sdW1uKGZyb20sIHRvKSB7XG4gICAgY29uc3QgY29tcGlsZXIgPSB0aGlzO1xuICAgIGNvbnN0IHRhYmxlID0gdGhpcy50YWJsZU5hbWUoKTtcbiAgICBjb25zdCB3cmFwcGVkID0gdGhpcy5mb3JtYXR0ZXIud3JhcChmcm9tKSArICcgJyArIHRoaXMuZm9ybWF0dGVyLndyYXAodG8pO1xuXG4gICAgdGhpcy5wdXNoUXVlcnkoe1xuICAgICAgc3FsOiBgc2hvdyBmaWVsZHMgZnJvbSAke3RhYmxlfSB3aGVyZSBmaWVsZCA9IGAgK1xuICAgICAgICB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIoZnJvbSksXG4gICAgICBvdXRwdXQocmVzcCkge1xuICAgICAgICBjb25zdCBjb2x1bW4gPSByZXNwWzBdO1xuICAgICAgICBjb25zdCBydW5uZXIgPSB0aGlzO1xuICAgICAgICByZXR1cm4gY29tcGlsZXIuZ2V0RktSZWZzKHJ1bm5lcikuZ2V0KDApXG4gICAgICAgICAgLnRoZW4ocmVmcyA9PlxuICAgICAgICAgICAgUHJvbWlzZS50cnkoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICBpZiAoIXJlZnMubGVuZ3RoKSB7IHJldHVybjsgfVxuICAgICAgICAgICAgICByZXR1cm4gY29tcGlsZXIuZHJvcEZLUmVmcyhydW5uZXIsIHJlZnMpO1xuICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgIGxldCBzcWwgPSBgYWx0ZXIgdGFibGUgJHt0YWJsZX0gY2hhbmdlICR7d3JhcHBlZH0gJHtjb2x1bW4uVHlwZX1gO1xuXG4gICAgICAgICAgICAgIGlmKFN0cmluZyhjb2x1bW4uTnVsbCkudG9VcHBlckNhc2UoKSAhPT0gJ1lFUycpIHtcbiAgICAgICAgICAgICAgICBzcWwgKz0gYCBOT1QgTlVMTGBcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZihjb2x1bW4uRGVmYXVsdCAhPT0gdm9pZCAwICYmIGNvbHVtbi5EZWZhdWx0ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgc3FsICs9IGAgREVGQVVMVCAnJHtjb2x1bW4uRGVmYXVsdH0nYFxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgcmV0dXJuIHJ1bm5lci5xdWVyeSh7XG4gICAgICAgICAgICAgICAgc3FsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgIGlmICghcmVmcy5sZW5ndGgpIHsgcmV0dXJuOyB9XG4gICAgICAgICAgICAgIHJldHVybiBjb21waWxlci5jcmVhdGVGS1JlZnMocnVubmVyLCByZWZzLm1hcChmdW5jdGlvbiAocmVmKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlZi5SRUZFUkVOQ0VEX0NPTFVNTl9OQU1FID09PSBmcm9tKSB7XG4gICAgICAgICAgICAgICAgICByZWYuUkVGRVJFTkNFRF9DT0xVTU5fTkFNRSA9IHRvO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVmLkNPTFVNTl9OQU1FID09PSBmcm9tKSB7XG4gICAgICAgICAgICAgICAgICByZWYuQ09MVU1OX05BTUUgPSB0bztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlZjtcbiAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9LFxuXG4gIGdldEZLUmVmcyAocnVubmVyKSB7XG4gICAgY29uc3QgZm9ybWF0dGVyID0gdGhpcy5jbGllbnQuZm9ybWF0dGVyKCk7XG4gICAgY29uc3Qgc3FsID0gJ1NFTEVDVCBLQ1UuQ09OU1RSQUlOVF9OQU1FLCBLQ1UuVEFCTEVfTkFNRSwgS0NVLkNPTFVNTl9OQU1FLCAnK1xuICAgICAgICAgICAgICAnICAgICAgIEtDVS5SRUZFUkVOQ0VEX1RBQkxFX05BTUUsIEtDVS5SRUZFUkVOQ0VEX0NPTFVNTl9OQU1FLCAnK1xuICAgICAgICAgICAgICAnICAgICAgIFJDLlVQREFURV9SVUxFLCBSQy5ERUxFVEVfUlVMRSAnK1xuICAgICAgICAgICAgICAnRlJPTSBJTkZPUk1BVElPTl9TQ0hFTUEuS0VZX0NPTFVNTl9VU0FHRSBBUyBLQ1UgJytcbiAgICAgICAgICAgICAgJ0pPSU4gSU5GT1JNQVRJT05fU0NIRU1BLlJFRkVSRU5USUFMX0NPTlNUUkFJTlRTIEFTIFJDICcrXG4gICAgICAgICAgICAgICcgICAgICAgVVNJTkcoQ09OU1RSQUlOVF9OQU1FKScgK1xuICAgICAgICAgICAgICAnV0hFUkUgS0NVLlJFRkVSRU5DRURfVEFCTEVfTkFNRSA9ICcgKyBmb3JtYXR0ZXIucGFyYW1ldGVyKHRoaXMudGFibGVOYW1lUmF3KSArICcgJytcbiAgICAgICAgICAgICAgJyAgQU5EIEtDVS5DT05TVFJBSU5UX1NDSEVNQSA9ICcgKyBmb3JtYXR0ZXIucGFyYW1ldGVyKHRoaXMuY2xpZW50LmRhdGFiYXNlKCkpICsgJyAnK1xuICAgICAgICAgICAgICAnICBBTkQgUkMuQ09OU1RSQUlOVF9TQ0hFTUEgPSAnICsgZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLmNsaWVudC5kYXRhYmFzZSgpKTtcblxuICAgIHJldHVybiBydW5uZXIucXVlcnkoe1xuICAgICAgc3FsLFxuICAgICAgYmluZGluZ3M6IGZvcm1hdHRlci5iaW5kaW5nc1xuICAgIH0pO1xuICB9LFxuXG4gIGRyb3BGS1JlZnMgKHJ1bm5lciwgcmVmcykge1xuICAgIGNvbnN0IGZvcm1hdHRlciA9IHRoaXMuY2xpZW50LmZvcm1hdHRlcigpO1xuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHJlZnMubWFwKGZ1bmN0aW9uIChyZWYpIHtcbiAgICAgIGNvbnN0IGNvbnN0cmFpbnROYW1lID0gZm9ybWF0dGVyLndyYXAocmVmLkNPTlNUUkFJTlRfTkFNRSk7XG4gICAgICBjb25zdCB0YWJsZU5hbWUgPSBmb3JtYXR0ZXIud3JhcChyZWYuVEFCTEVfTkFNRSk7XG4gICAgICByZXR1cm4gcnVubmVyLnF1ZXJ5KHtcbiAgICAgICAgc3FsOiBgYWx0ZXIgdGFibGUgJHt0YWJsZU5hbWV9IGRyb3AgZm9yZWlnbiBrZXkgJHtjb25zdHJhaW50TmFtZX1gXG4gICAgICB9KTtcbiAgICB9KSk7XG4gIH0sXG4gIGNyZWF0ZUZLUmVmcyAocnVubmVyLCByZWZzKSB7XG4gICAgY29uc3QgZm9ybWF0dGVyID0gdGhpcy5jbGllbnQuZm9ybWF0dGVyKCk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVmcy5tYXAoZnVuY3Rpb24gKHJlZikge1xuICAgICAgY29uc3QgdGFibGVOYW1lID0gZm9ybWF0dGVyLndyYXAocmVmLlRBQkxFX05BTUUpO1xuICAgICAgY29uc3Qga2V5TmFtZSA9IGZvcm1hdHRlci53cmFwKHJlZi5DT05TVFJBSU5UX05BTUUpO1xuICAgICAgY29uc3QgY29sdW1uID0gZm9ybWF0dGVyLmNvbHVtbml6ZShyZWYuQ09MVU1OX05BTUUpO1xuICAgICAgY29uc3QgcmVmZXJlbmNlcyA9IGZvcm1hdHRlci5jb2x1bW5pemUocmVmLlJFRkVSRU5DRURfQ09MVU1OX05BTUUpO1xuICAgICAgY29uc3QgaW5UYWJsZSA9IGZvcm1hdHRlci53cmFwKHJlZi5SRUZFUkVOQ0VEX1RBQkxFX05BTUUpO1xuICAgICAgY29uc3Qgb25VcGRhdGUgPSBgIE9OIFVQREFURSAke3JlZi5VUERBVEVfUlVMRX1gO1xuICAgICAgY29uc3Qgb25EZWxldGUgPSBgIE9OIERFTEVURSAke3JlZi5ERUxFVEVfUlVMRX1gO1xuXG4gICAgICByZXR1cm4gcnVubmVyLnF1ZXJ5KHtcbiAgICAgICAgc3FsOiBgYWx0ZXIgdGFibGUgJHt0YWJsZU5hbWV9IGFkZCBjb25zdHJhaW50ICR7a2V5TmFtZX0gYCArXG4gICAgICAgICAgJ2ZvcmVpZ24ga2V5ICgnICsgY29sdW1uICsgJykgcmVmZXJlbmNlcyAnICsgaW5UYWJsZSArICcgKCcgKyByZWZlcmVuY2VzICsgJyknICsgb25VcGRhdGUgKyBvbkRlbGV0ZVxuICAgICAgfSk7XG4gICAgfSkpO1xuICB9LFxuICBpbmRleChjb2x1bW5zLCBpbmRleE5hbWUpIHtcbiAgICBpbmRleE5hbWUgPSBpbmRleE5hbWUgPyB0aGlzLmZvcm1hdHRlci53cmFwKGluZGV4TmFtZSkgOiB0aGlzLl9pbmRleENvbW1hbmQoJ2luZGV4JywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpO1xuICAgIHRoaXMucHVzaFF1ZXJ5KGBhbHRlciB0YWJsZSAke3RoaXMudGFibGVOYW1lKCl9IGFkZCBpbmRleCAke2luZGV4TmFtZX0oJHt0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucyl9KWApO1xuICB9LFxuXG4gIHByaW1hcnkoY29sdW1ucywgY29uc3RyYWludE5hbWUpIHtcbiAgICBjb25zdHJhaW50TmFtZSA9IGNvbnN0cmFpbnROYW1lID8gdGhpcy5mb3JtYXR0ZXIud3JhcChjb25zdHJhaW50TmFtZSkgOiB0aGlzLmZvcm1hdHRlci53cmFwKGAke3RoaXMudGFibGVOYW1lUmF3fV9wa2V5YCk7XG4gICAgdGhpcy5wdXNoUXVlcnkoYGFsdGVyIHRhYmxlICR7dGhpcy50YWJsZU5hbWUoKX0gYWRkIHByaW1hcnkga2V5ICR7Y29uc3RyYWludE5hbWV9KCR7dGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGNvbHVtbnMpfSlgKTtcbiAgfSxcblxuICB1bmlxdWUoY29sdW1ucywgaW5kZXhOYW1lKSB7XG4gICAgaW5kZXhOYW1lID0gaW5kZXhOYW1lID8gdGhpcy5mb3JtYXR0ZXIud3JhcChpbmRleE5hbWUpIDogdGhpcy5faW5kZXhDb21tYW5kKCd1bmlxdWUnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gICAgdGhpcy5wdXNoUXVlcnkoYGFsdGVyIHRhYmxlICR7dGhpcy50YWJsZU5hbWUoKX0gYWRkIHVuaXF1ZSAke2luZGV4TmFtZX0oJHt0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucyl9KWApO1xuICB9LFxuXG4gIC8vIENvbXBpbGUgYSBkcm9wIGluZGV4IGNvbW1hbmQuXG4gIGRyb3BJbmRleChjb2x1bW5zLCBpbmRleE5hbWUpIHtcbiAgICBpbmRleE5hbWUgPSBpbmRleE5hbWUgPyB0aGlzLmZvcm1hdHRlci53cmFwKGluZGV4TmFtZSkgOiB0aGlzLl9pbmRleENvbW1hbmQoJ2luZGV4JywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpO1xuICAgIHRoaXMucHVzaFF1ZXJ5KGBhbHRlciB0YWJsZSAke3RoaXMudGFibGVOYW1lKCl9IGRyb3AgaW5kZXggJHtpbmRleE5hbWV9YCk7XG4gIH0sXG5cbiAgLy8gQ29tcGlsZSBhIGRyb3AgZm9yZWlnbiBrZXkgY29tbWFuZC5cbiAgZHJvcEZvcmVpZ24oY29sdW1ucywgaW5kZXhOYW1lKSB7XG4gICAgaW5kZXhOYW1lID0gaW5kZXhOYW1lID8gdGhpcy5mb3JtYXR0ZXIud3JhcChpbmRleE5hbWUpIDogdGhpcy5faW5kZXhDb21tYW5kKCdmb3JlaWduJywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpO1xuICAgIHRoaXMucHVzaFF1ZXJ5KGBhbHRlciB0YWJsZSAke3RoaXMudGFibGVOYW1lKCl9IGRyb3AgZm9yZWlnbiBrZXkgJHtpbmRleE5hbWV9YCk7XG4gIH0sXG5cbiAgLy8gQ29tcGlsZSBhIGRyb3AgcHJpbWFyeSBrZXkgY29tbWFuZC5cbiAgZHJvcFByaW1hcnkoKSB7XG4gICAgdGhpcy5wdXNoUXVlcnkoYGFsdGVyIHRhYmxlICR7dGhpcy50YWJsZU5hbWUoKX0gZHJvcCBwcmltYXJ5IGtleWApO1xuICB9LFxuXG4gIC8vIENvbXBpbGUgYSBkcm9wIHVuaXF1ZSBrZXkgY29tbWFuZC5cbiAgZHJvcFVuaXF1ZShjb2x1bW4sIGluZGV4TmFtZSkge1xuICAgIGluZGV4TmFtZSA9IGluZGV4TmFtZSA/IHRoaXMuZm9ybWF0dGVyLndyYXAoaW5kZXhOYW1lKSA6IHRoaXMuX2luZGV4Q29tbWFuZCgndW5pcXVlJywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbik7XG4gICAgdGhpcy5wdXNoUXVlcnkoYGFsdGVyIHRhYmxlICR7dGhpcy50YWJsZU5hbWUoKX0gZHJvcCBpbmRleCAke2luZGV4TmFtZX1gKTtcbiAgfVxuXG59KVxuXG5leHBvcnQgZGVmYXVsdCBUYWJsZUNvbXBpbGVyX015U1FMO1xuIl19