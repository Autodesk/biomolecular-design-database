
// Oracledb Client
// -------
'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var Client_Oracle = require('../oracle');
var QueryCompiler = require('./query/compiler');
var ColumnCompiler = require('./schema/columncompiler');
var Formatter = require('./formatter');
var BlobHelper = require('./utils').BlobHelper;
var ReturningHelper = require('./utils').ReturningHelper;
var Promise = require('../../promise');
var stream = require('stream');
var helpers = require('../../helpers');
var Transaction = require('./transaction');

function Client_Oracledb() {
  Client_Oracle.apply(this, arguments);
  // Node.js only have 4 background threads by default, oracledb needs one by connection
  if (this.driver) {
    process.env.UV_THREADPOOL_SIZE = process.env.UV_THREADPOOL_SIZE || 1;
    process.env.UV_THREADPOOL_SIZE += this.driver.poolMax;
  }
}
inherits(Client_Oracledb, Client_Oracle);

Client_Oracledb.prototype.driverName = 'oracledb';

Client_Oracledb.prototype._driver = function () {
  var oracledb = require('oracledb');
  return oracledb;
};

Client_Oracledb.prototype.QueryCompiler = QueryCompiler;
Client_Oracledb.prototype.ColumnCompiler = ColumnCompiler;
Client_Oracledb.prototype.Formatter = Formatter;
Client_Oracledb.prototype.Transaction = Transaction;

Client_Oracledb.prototype.prepBindings = function (bindings) {
  var self = this;
  return _.map(bindings, function (value) {
    if (value instanceof BlobHelper && self.driver) {
      return { type: self.driver.BLOB, dir: self.driver.BIND_OUT };
      // Returning helper always use ROWID as string
    } else if (value instanceof ReturningHelper && self.driver) {
        return { type: self.driver.STRING, dir: self.driver.BIND_OUT };
      } else if (typeof value === 'boolean') {
        return value ? 1 : 0;
      }
    return value;
  });
};

// Get a raw connection, called by the `pool` whenever a new
// connection needs to be added to the pool.
Client_Oracledb.prototype.acquireRawConnection = function () {
  var client = this;
  var asyncConnection = new Promise(function (resolver, rejecter) {
    client.driver.getConnection({
      user: client.connectionSettings.user,
      password: client.connectionSettings.password,
      connectString: client.connectionSettings.host + '/' + client.connectionSettings.database
    }, function (err, connection) {
      if (err) return rejecter(err);
      if (client.connectionSettings.prefetchRowCount) {
        connection.setPrefetchRowCount(client.connectionSettings.prefetchRowCount);
      }

      connection.commitAsync = function () {
        var self = this;
        return new Promise(function (commitResolve, commitReject) {
          if (connection.isTransaction) {
            return commitResolve();
          }
          self.commit(function (err) {
            if (err) {
              return commitReject(err);
            }
            commitResolve();
          });
        });
      };
      connection.rollbackAsync = function () {
        var self = this;
        return new Promise(function (rollbackResolve, rollbackReject) {
          self.rollback(function (err) {
            if (err) {
              return rollbackReject(err);
            }
            rollbackResolve();
          });
        });
      };
      var fetchAsync = function fetchAsync(sql, bindParams, options, cb) {
        options = options || {};
        options.outFormat = client.driver.OBJECT;
        if (options.resultSet) {
          connection.execute(sql, bindParams || [], options, function (err, result) {
            if (err) {
              return cb(err);
            }
            var fetchResult = { rows: [], resultSet: result.resultSet };
            var numRows = 100;
            var fetchRowsFromRS = function fetchRowsFromRS(connection, resultSet, numRows) {
              resultSet.getRows(numRows, function (err, rows) {
                if (err) {
                  resultSet.close(function () {
                    return cb(err);
                  });
                } else if (rows.length === 0) {
                  return cb(null, fetchResult);
                } else if (rows.length > 0) {
                  if (rows.length === numRows) {
                    fetchResult.rows = fetchResult.rows.concat(rows);
                    fetchRowsFromRS(connection, resultSet, numRows);
                  } else {
                    fetchResult.rows = fetchResult.rows.concat(rows);
                    return cb(null, fetchResult);
                  }
                }
              });
            };
            fetchRowsFromRS(connection, result.resultSet, numRows);
          });
        } else {
          connection.execute(sql, bindParams || [], options, cb);
        }
      };
      connection.executeAsync = function (sql, bindParams, options) {
        // Read all lob
        return new Promise(function (resultResolve, resultReject) {
          fetchAsync(sql, bindParams, options, function (err, results) {
            if (err) {
              return resultReject(err);
            }
            // Collect LOBs to read
            var lobs = [];
            if (results.rows) {
              if (Array.isArray(results.rows)) {
                for (var i = 0; i < results.rows.length; i++) {
                  // Iterate through the rows
                  var row = results.rows[i];
                  for (var column in row) {
                    if (row[column] instanceof stream.Readable) {
                      lobs.push({ index: i, key: column, stream: row[column] });
                    }
                  }
                }
              }
            }
            Promise.each(lobs, function (lob) {
              return new Promise(function (lobResolve, lobReject) {

                readStream(lob.stream, function (err, d) {
                  if (err) {
                    if (results.resultSet) {
                      results.resultSet.close(function () {
                        return lobReject(err);
                      });
                    }
                    return lobReject(err);
                  }
                  results.rows[lob.index][lob.key] = d;
                  lobResolve();
                });
              });
            }).then(function () {
              if (results.resultSet) {
                results.resultSet.close(function (err) {
                  if (err) {
                    return resultReject(err);
                  }
                  return resultResolve(results);
                });
              }
              resultResolve(results);
            }, function (err) {
              resultReject(err);
            });
          });
        });
      };
      resolver(connection);
    });
  });
  return asyncConnection;
};

// Used to explicitly close a connection, called internally by the pool
// when a connection times out or the pool is shutdown.
Client_Oracledb.prototype.destroyRawConnection = function (connection, cb) {
  connection.release(cb);
};

// Runs the query on the specified connection, providing the bindings
// and any other necessary prep work.
Client_Oracledb.prototype._query = function (connection, obj) {
  // Convert ? params into positional bindings (:1)
  obj.sql = this.positionBindings(obj.sql);
  obj.bindings = this.prepBindings(obj.bindings) || [];

  return new Promise(function (resolver, rejecter) {
    if (!obj.sql) {
      return rejecter(new Error('The query is empty'));
    }
    var options = { autoCommit: false };
    if (obj.method === 'select') {
      options.resultSet = true;
    }
    connection.executeAsync(obj.sql, obj.bindings, options).then(function (response) {
      // Flatten outBinds
      var outBinds = _.flatten(response.outBinds);
      obj.response = response.rows || [];
      obj.rowsAffected = response.rows ? response.rows.rowsAffected : response.rowsAffected;

      if (obj.method === 'update') {
        (function () {
          var modifiedRowsCount = obj.rowsAffected.length || obj.rowsAffected;
          var updatedObjOutBinding = [];
          var updatedOutBinds = [];
          var updateOutBinds = function updateOutBinds(i) {
            return function (value, index) {
              var OutBindsOffset = index * modifiedRowsCount;
              updatedOutBinds.push(outBinds[i + OutBindsOffset]);
            };
          };

          for (var i = 0; i < modifiedRowsCount; i++) {
            updatedObjOutBinding.push(obj.outBinding[0]);
            _.each(obj.outBinding[0], updateOutBinds(i));
          }
          outBinds = updatedOutBinds;
          obj.outBinding = updatedObjOutBinding;
        })();
      }

      if (!obj.returning && outBinds.length === 0) {
        return connection.commitAsync().then(function () {
          resolver(obj);
        });
      }
      var rowIds = [];
      var offset = 0;
      Promise.each(obj.outBinding, function (ret, line) {
        offset = offset + (obj.outBinding[line - 1] ? obj.outBinding[line - 1].length : 0);
        return Promise.each(ret, function (out, index) {
          return new Promise(function (bindResolver, bindRejecter) {
            if (out instanceof BlobHelper) {
              var blob = outBinds[index + offset];
              if (out.returning) {
                obj.response[line] = obj.response[line] || {};
                obj.response[line][out.columnName] = out.value;
              }
              blob.on('error', function (err) {
                bindRejecter(err);
              });
              blob.on('finish', function () {
                bindResolver();
              });
              blob.write(out.value);
              blob.end();
            } else if (obj.outBinding[line][index] === 'ROWID') {
              rowIds.push(outBinds[index + offset]);
              bindResolver();
            } else {
              obj.response[line] = obj.response[line] || {};
              obj.response[line][out] = outBinds[index + offset];
              bindResolver();
            }
          });
        });
      }).then(function () {
        return connection.commitAsync();
      }).then(function () {
        if (obj.returningSql) {
          return connection.executeAsync(obj.returningSql(), rowIds, { resultSet: true }).then(function (response) {
            obj.response = response.rows;
            return obj;
          }, rejecter);
        }
        return obj;
      }, rejecter).then(function (obj) {
        resolver(obj);
      });
    }, rejecter);
  });
};

// Handle clob
function readStream(stream, cb) {
  var oracledb = require('oracledb');
  var data = '';

  if (stream.iLob.type === oracledb.CLOB) {
    stream.setEncoding('utf-8');
  } else {
    data = new Buffer(0);
  }
  stream.on('error', function (err) {
    cb(err);
  });
  stream.on('data', function (chunk) {
    if (stream.iLob.type === oracledb.CLOB) {
      data += chunk;
    } else {
      data = Buffer.concat([data, chunk]);
    }
  });
  stream.on('end', function () {
    cb(null, data);
  });
}

// Process the response as returned from the query.
Client_Oracledb.prototype.processResponse = function (obj, runner) {
  var response = obj.response;
  var method = obj.method;
  if (obj.output) {
    return obj.output.call(runner, response);
  }
  switch (method) {
    case 'select':
    case 'pluck':
    case 'first':
      response = helpers.skim(response);
      if (obj.method === 'pluck') response = _.pluck(response, obj.pluck);
      return obj.method === 'first' ? response[0] : response;
    case 'insert':
    case 'del':
    case 'update':
    case 'counter':
      if (obj.returning) {
        if (obj.returning.length === 1 && obj.returning[0] !== '*') {
          return _.flatten(_.map(response, _.values));
        }
        return response;
      } else if (!_.isUndefined(obj.rowsAffected)) {
        return obj.rowsAffected;
      } else {
        return 1;
      }
    default:
      return response;
  }
};

module.exports = Client_Oracledb;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9vcmFjbGVkYi9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUdBLElBQU0sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM1QixJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDckMsSUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQzNDLElBQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ2xELElBQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0FBQzFELElBQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUN6QyxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxDQUFDO0FBQ2pELElBQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxlQUFlLENBQUM7QUFDM0QsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pDLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQyxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDekMsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDOztBQUU3QyxTQUFTLGVBQWUsR0FBRztBQUN6QixlQUFhLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQzs7QUFFckMsTUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO0FBQ2YsV0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLENBQUMsQ0FBQztBQUNyRSxXQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FB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Iiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBPcmFjbGVkYiBDbGllbnRcbi8vIC0tLS0tLS1cbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTtcbmNvbnN0IENsaWVudF9PcmFjbGUgPSByZXF1aXJlKCcuLi9vcmFjbGUnKTtcbmNvbnN0IFF1ZXJ5Q29tcGlsZXIgPSByZXF1aXJlKCcuL3F1ZXJ5L2NvbXBpbGVyJyk7XG5jb25zdCBDb2x1bW5Db21waWxlciA9IHJlcXVpcmUoJy4vc2NoZW1hL2NvbHVtbmNvbXBpbGVyJyk7XG5jb25zdCBGb3JtYXR0ZXIgPSByZXF1aXJlKCcuL2Zvcm1hdHRlcicpO1xuY29uc3QgQmxvYkhlbHBlciA9IHJlcXVpcmUoJy4vdXRpbHMnKS5CbG9iSGVscGVyO1xuY29uc3QgUmV0dXJuaW5nSGVscGVyID0gcmVxdWlyZSgnLi91dGlscycpLlJldHVybmluZ0hlbHBlcjtcbmNvbnN0IFByb21pc2UgPSByZXF1aXJlKCcuLi8uLi9wcm9taXNlJyk7XG5jb25zdCBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbmNvbnN0IGhlbHBlcnMgPSByZXF1aXJlKCcuLi8uLi9oZWxwZXJzJyk7XG5jb25zdCBUcmFuc2FjdGlvbiA9IHJlcXVpcmUoJy4vdHJhbnNhY3Rpb24nKTtcblxuZnVuY3Rpb24gQ2xpZW50X09yYWNsZWRiKCkge1xuICBDbGllbnRfT3JhY2xlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gIC8vIE5vZGUuanMgb25seSBoYXZlIDQgYmFja2dyb3VuZCB0aHJlYWRzIGJ5IGRlZmF1bHQsIG9yYWNsZWRiIG5lZWRzIG9uZSBieSBjb25uZWN0aW9uXG4gIGlmICh0aGlzLmRyaXZlcikge1xuICAgIHByb2Nlc3MuZW52LlVWX1RIUkVBRFBPT0xfU0laRSA9IHByb2Nlc3MuZW52LlVWX1RIUkVBRFBPT0xfU0laRSB8fCAxO1xuICAgIHByb2Nlc3MuZW52LlVWX1RIUkVBRFBPT0xfU0laRSArPSB0aGlzLmRyaXZlci5wb29sTWF4O1xuICB9XG59XG5pbmhlcml0cyhDbGllbnRfT3JhY2xlZGIsIENsaWVudF9PcmFjbGUpO1xuXG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLmRyaXZlck5hbWUgPSAnb3JhY2xlZGInO1xuXG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLl9kcml2ZXIgPSBmdW5jdGlvbigpIHtcbiAgY29uc3Qgb3JhY2xlZGIgPSByZXF1aXJlKCdvcmFjbGVkYicpO1xuICByZXR1cm4gb3JhY2xlZGI7XG59O1xuXG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLlF1ZXJ5Q29tcGlsZXIgPSBRdWVyeUNvbXBpbGVyO1xuQ2xpZW50X09yYWNsZWRiLnByb3RvdHlwZS5Db2x1bW5Db21waWxlciA9IENvbHVtbkNvbXBpbGVyO1xuQ2xpZW50X09yYWNsZWRiLnByb3RvdHlwZS5Gb3JtYXR0ZXIgPSBGb3JtYXR0ZXI7XG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLlRyYW5zYWN0aW9uID0gVHJhbnNhY3Rpb247XG5cbkNsaWVudF9PcmFjbGVkYi5wcm90b3R5cGUucHJlcEJpbmRpbmdzID0gZnVuY3Rpb24oYmluZGluZ3MpIHtcbiAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gIHJldHVybiBfLm1hcChiaW5kaW5ncywgZnVuY3Rpb24odmFsdWUpIHtcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBCbG9iSGVscGVyICYmIHNlbGYuZHJpdmVyKSB7XG4gICAgICByZXR1cm4ge3R5cGU6IHNlbGYuZHJpdmVyLkJMT0IsIGRpcjogc2VsZi5kcml2ZXIuQklORF9PVVR9O1xuICAgICAgLy8gUmV0dXJuaW5nIGhlbHBlciBhbHdheXMgdXNlIFJPV0lEIGFzIHN0cmluZ1xuICAgIH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBSZXR1cm5pbmdIZWxwZXIgJiYgc2VsZi5kcml2ZXIpIHtcbiAgICAgIHJldHVybiB7dHlwZTogc2VsZi5kcml2ZXIuU1RSSU5HLCBkaXI6IHNlbGYuZHJpdmVyLkJJTkRfT1VUfTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICByZXR1cm4gdmFsdWUgPyAxIDogMDtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9KTtcbn07XG5cbi8vIEdldCBhIHJhdyBjb25uZWN0aW9uLCBjYWxsZWQgYnkgdGhlIGBwb29sYCB3aGVuZXZlciBhIG5ld1xuLy8gY29ubmVjdGlvbiBuZWVkcyB0byBiZSBhZGRlZCB0byB0aGUgcG9vbC5cbkNsaWVudF9PcmFjbGVkYi5wcm90b3R5cGUuYWNxdWlyZVJhd0Nvbm5lY3Rpb24gPSBmdW5jdGlvbigpIHtcbiAgY29uc3QgY2xpZW50ID0gdGhpcztcbiAgY29uc3QgYXN5bmNDb25uZWN0aW9uID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZXIsIHJlamVjdGVyKSB7XG4gICAgY2xpZW50LmRyaXZlci5nZXRDb25uZWN0aW9uKHtcbiAgICAgIHVzZXI6IGNsaWVudC5jb25uZWN0aW9uU2V0dGluZ3MudXNlcixcbiAgICAgIHBhc3N3b3JkOiBjbGllbnQuY29ubmVjdGlvblNldHRpbmdzLnBhc3N3b3JkLFxuICAgICAgY29ubmVjdFN0cmluZzogY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5ncy5ob3N0ICsgJy8nICsgY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5ncy5kYXRhYmFzZVxuICAgIH0sIGZ1bmN0aW9uKGVyciwgY29ubmVjdGlvbikge1xuICAgICAgaWYgKGVycilcbiAgICAgICAgcmV0dXJuIHJlamVjdGVyKGVycik7XG4gICAgICBpZiAoY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5ncy5wcmVmZXRjaFJvd0NvdW50KSB7XG4gICAgICAgIGNvbm5lY3Rpb24uc2V0UHJlZmV0Y2hSb3dDb3VudChjbGllbnQuY29ubmVjdGlvblNldHRpbmdzLnByZWZldGNoUm93Q291bnQpO1xuICAgICAgfVxuXG4gICAgICBjb25uZWN0aW9uLmNvbW1pdEFzeW5jID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24oY29tbWl0UmVzb2x2ZSwgY29tbWl0UmVqZWN0KSB7XG4gICAgICAgICAgaWYgKGNvbm5lY3Rpb24uaXNUcmFuc2FjdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIGNvbW1pdFJlc29sdmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgc2VsZi5jb21taXQoZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiBjb21taXRSZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbW1pdFJlc29sdmUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgICAgY29ubmVjdGlvbi5yb2xsYmFja0FzeW5jID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocm9sbGJhY2tSZXNvbHZlLCByb2xsYmFja1JlamVjdCkge1xuICAgICAgICAgIHNlbGYucm9sbGJhY2soZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiByb2xsYmFja1JlamVjdChlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcm9sbGJhY2tSZXNvbHZlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICAgIGNvbnN0IGZldGNoQXN5bmMgPSBmdW5jdGlvbihzcWwsIGJpbmRQYXJhbXMsIG9wdGlvbnMsIGNiKSB7XG4gICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgICAgICBvcHRpb25zLm91dEZvcm1hdCA9IGNsaWVudC5kcml2ZXIuT0JKRUNUO1xuICAgICAgICBpZiAob3B0aW9ucy5yZXN1bHRTZXQpIHtcbiAgICAgICAgICBjb25uZWN0aW9uLmV4ZWN1dGUoc3FsLCBiaW5kUGFyYW1zIHx8IFtdLCBvcHRpb25zLCBmdW5jdGlvbihlcnIsIHJlc3VsdCkge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGZldGNoUmVzdWx0ID0ge3Jvd3M6IFtdLCByZXN1bHRTZXQ6IHJlc3VsdC5yZXN1bHRTZXR9O1xuICAgICAgICAgICAgY29uc3QgbnVtUm93cyA9IDEwMDtcbiAgICAgICAgICAgIGNvbnN0IGZldGNoUm93c0Zyb21SUyA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIHJlc3VsdFNldCwgbnVtUm93cykge1xuICAgICAgICAgICAgICByZXN1bHRTZXQuZ2V0Um93cyhudW1Sb3dzLCBmdW5jdGlvbihlcnIsIHJvd3MpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHRTZXQuY2xvc2UoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyb3dzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIGZldGNoUmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJvd3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgaWYgKHJvd3MubGVuZ3RoID09PSBudW1Sb3dzKSB7XG4gICAgICAgICAgICAgICAgICAgIGZldGNoUmVzdWx0LnJvd3MgPSBmZXRjaFJlc3VsdC5yb3dzLmNvbmNhdChyb3dzKTtcbiAgICAgICAgICAgICAgICAgICAgZmV0Y2hSb3dzRnJvbVJTKGNvbm5lY3Rpb24sIHJlc3VsdFNldCwgbnVtUm93cyk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmZXRjaFJlc3VsdC5yb3dzID0gZmV0Y2hSZXN1bHQucm93cy5jb25jYXQocm93cyk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjYihudWxsLCBmZXRjaFJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBmZXRjaFJvd3NGcm9tUlMoY29ubmVjdGlvbiwgcmVzdWx0LnJlc3VsdFNldCwgbnVtUm93cyk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29ubmVjdGlvbi5leGVjdXRlKHNxbCwgYmluZFBhcmFtcyB8fCBbXSwgb3B0aW9ucywgY2IpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgY29ubmVjdGlvbi5leGVjdXRlQXN5bmMgPSBmdW5jdGlvbihzcWwsIGJpbmRQYXJhbXMsIG9wdGlvbnMpIHtcbiAgICAgICAgLy8gUmVhZCBhbGwgbG9iXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXN1bHRSZXNvbHZlLCByZXN1bHRSZWplY3QpIHtcbiAgICAgICAgICBmZXRjaEFzeW5jKHNxbCwgYmluZFBhcmFtcywgb3B0aW9ucywgZnVuY3Rpb24oZXJyLCByZXN1bHRzKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZXN1bHRSZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIENvbGxlY3QgTE9CcyB0byByZWFkXG4gICAgICAgICAgICBjb25zdCBsb2JzID0gW107XG4gICAgICAgICAgICBpZiAocmVzdWx0cy5yb3dzKSB7XG4gICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdHMucm93cykpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdHMucm93cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgLy8gSXRlcmF0ZSB0aHJvdWdoIHRoZSByb3dzXG4gICAgICAgICAgICAgICAgICBjb25zdCByb3cgPSByZXN1bHRzLnJvd3NbaV07XG4gICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGNvbHVtbiBpbiByb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJvd1tjb2x1bW5dIGluc3RhbmNlb2Ygc3RyZWFtLlJlYWRhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgbG9icy5wdXNoKHtpbmRleDogaSwga2V5OiBjb2x1bW4sIHN0cmVhbTogcm93W2NvbHVtbl19KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgUHJvbWlzZS5lYWNoKGxvYnMsIGZ1bmN0aW9uKGxvYikge1xuICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24obG9iUmVzb2x2ZSwgbG9iUmVqZWN0KSB7XG5cbiAgICAgICAgICAgICAgICByZWFkU3RyZWFtKGxvYi5zdHJlYW0sIGZ1bmN0aW9uKGVyciwgZCkge1xuICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5yZXN1bHRTZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnJlc3VsdFNldC5jbG9zZShmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2JSZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9iUmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICByZXN1bHRzLnJvd3NbbG9iLmluZGV4XVtsb2Iua2V5XSA9IGQ7XG4gICAgICAgICAgICAgICAgICBsb2JSZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdHMucmVzdWx0U2V0KSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0cy5yZXN1bHRTZXQuY2xvc2UoZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRSZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRSZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJlc3VsdFJlc29sdmUocmVzdWx0cyk7XG4gICAgICAgICAgICB9LCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgcmVzdWx0UmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgICAgcmVzb2x2ZXIoY29ubmVjdGlvbik7XG4gICAgfSk7XG4gIH0pO1xuICByZXR1cm4gYXN5bmNDb25uZWN0aW9uO1xufTtcblxuLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2xcbi8vIHdoZW4gYSBjb25uZWN0aW9uIHRpbWVzIG91dCBvciB0aGUgcG9vbCBpcyBzaHV0ZG93bi5cbkNsaWVudF9PcmFjbGVkYi5wcm90b3R5cGUuZGVzdHJveVJhd0Nvbm5lY3Rpb24gPSBmdW5jdGlvbihjb25uZWN0aW9uLCBjYikge1xuICBjb25uZWN0aW9uLnJlbGVhc2UoY2IpO1xufTtcblxuLy8gUnVucyB0aGUgcXVlcnkgb24gdGhlIHNwZWNpZmllZCBjb25uZWN0aW9uLCBwcm92aWRpbmcgdGhlIGJpbmRpbmdzXG4vLyBhbmQgYW55IG90aGVyIG5lY2Vzc2FyeSBwcmVwIHdvcmsuXG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLl9xdWVyeSA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIG9iaikge1xuICAvLyBDb252ZXJ0ID8gcGFyYW1zIGludG8gcG9zaXRpb25hbCBiaW5kaW5ncyAoOjEpXG4gIG9iai5zcWwgPSB0aGlzLnBvc2l0aW9uQmluZGluZ3Mob2JqLnNxbCk7XG4gIG9iai5iaW5kaW5ncyA9IHRoaXMucHJlcEJpbmRpbmdzKG9iai5iaW5kaW5ncykgfHwgW107XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgIGlmICghb2JqLnNxbCkge1xuICAgICAgcmV0dXJuIHJlamVjdGVyKG5ldyBFcnJvcignVGhlIHF1ZXJ5IGlzIGVtcHR5JykpO1xuICAgIH1cbiAgICBjb25zdCBvcHRpb25zID0ge2F1dG9Db21taXQ6IGZhbHNlfTtcbiAgICBpZiAob2JqLm1ldGhvZCA9PT0gJ3NlbGVjdCcpIHtcbiAgICAgIG9wdGlvbnMucmVzdWx0U2V0ID0gdHJ1ZTtcbiAgICB9XG4gICAgY29ubmVjdGlvbi5leGVjdXRlQXN5bmMob2JqLnNxbCwgb2JqLmJpbmRpbmdzLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAvLyBGbGF0dGVuIG91dEJpbmRzXG4gICAgICBsZXQgb3V0QmluZHMgPSBfLmZsYXR0ZW4ocmVzcG9uc2Uub3V0QmluZHMpO1xuICAgICAgb2JqLnJlc3BvbnNlID0gcmVzcG9uc2Uucm93cyB8fCBbXTtcbiAgICAgIG9iai5yb3dzQWZmZWN0ZWQgPSByZXNwb25zZS5yb3dzID8gcmVzcG9uc2Uucm93cy5yb3dzQWZmZWN0ZWQgOiByZXNwb25zZS5yb3dzQWZmZWN0ZWQ7XG5cbiAgICAgIGlmIChvYmoubWV0aG9kID09PSAndXBkYXRlJykge1xuICAgICAgICBjb25zdCBtb2RpZmllZFJvd3NDb3VudCA9IG9iai5yb3dzQWZmZWN0ZWQubGVuZ3RoIHx8IG9iai5yb3dzQWZmZWN0ZWQ7XG4gICAgICAgIGNvbnN0IHVwZGF0ZWRPYmpPdXRCaW5kaW5nID0gW107XG4gICAgICAgIGNvbnN0IHVwZGF0ZWRPdXRCaW5kcyA9IFtdO1xuICAgICAgICBjb25zdCB1cGRhdGVPdXRCaW5kcyA9IChpKSA9PiBmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHtcbiAgICAgICAgICBjb25zdCBPdXRCaW5kc09mZnNldCA9IGluZGV4ICogbW9kaWZpZWRSb3dzQ291bnQ7XG4gICAgICAgICAgdXBkYXRlZE91dEJpbmRzLnB1c2gob3V0QmluZHNbaSArIE91dEJpbmRzT2Zmc2V0XSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtb2RpZmllZFJvd3NDb3VudDsgaSsrKSB7XG4gICAgICAgICAgdXBkYXRlZE9iak91dEJpbmRpbmcucHVzaChvYmoub3V0QmluZGluZ1swXSk7XG4gICAgICAgICAgXy5lYWNoKG9iai5vdXRCaW5kaW5nWzBdLCB1cGRhdGVPdXRCaW5kcyhpKSk7XG4gICAgICAgIH1cbiAgICAgICAgb3V0QmluZHMgPSB1cGRhdGVkT3V0QmluZHM7XG4gICAgICAgIG9iai5vdXRCaW5kaW5nID0gdXBkYXRlZE9iak91dEJpbmRpbmc7XG4gICAgICB9XG5cbiAgICAgIGlmICghb2JqLnJldHVybmluZyAmJiBvdXRCaW5kcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb24uY29tbWl0QXN5bmMoKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHJlc29sdmVyKG9iaik7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgY29uc3Qgcm93SWRzID0gW107XG4gICAgICBsZXQgb2Zmc2V0ID0gMDtcbiAgICAgIFByb21pc2UuZWFjaChvYmoub3V0QmluZGluZywgZnVuY3Rpb24ocmV0LCBsaW5lKSB7XG4gICAgICAgIG9mZnNldCA9IG9mZnNldCArIChvYmoub3V0QmluZGluZ1tsaW5lIC0gMV0gPyBvYmoub3V0QmluZGluZ1tsaW5lIC0gMV0ubGVuZ3RoIDogMCk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLmVhY2gocmV0LCBmdW5jdGlvbihvdXQsIGluZGV4KSB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKGJpbmRSZXNvbHZlciwgYmluZFJlamVjdGVyKSB7XG4gICAgICAgICAgICBpZiAob3V0IGluc3RhbmNlb2YgQmxvYkhlbHBlcikge1xuICAgICAgICAgICAgICBjb25zdCBibG9iID0gb3V0QmluZHNbaW5kZXggKyBvZmZzZXRdO1xuICAgICAgICAgICAgICBpZiAob3V0LnJldHVybmluZykge1xuICAgICAgICAgICAgICAgIG9iai5yZXNwb25zZVtsaW5lXSA9IG9iai5yZXNwb25zZVtsaW5lXSB8fCB7fTtcbiAgICAgICAgICAgICAgICBvYmoucmVzcG9uc2VbbGluZV1bb3V0LmNvbHVtbk5hbWVdID0gb3V0LnZhbHVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJsb2Iub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgYmluZFJlamVjdGVyKGVycik7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBibG9iLm9uKCdmaW5pc2gnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBiaW5kUmVzb2x2ZXIoKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIGJsb2Iud3JpdGUob3V0LnZhbHVlKTtcbiAgICAgICAgICAgICAgYmxvYi5lbmQoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAob2JqLm91dEJpbmRpbmdbbGluZV1baW5kZXhdID09PSAnUk9XSUQnKSB7XG4gICAgICAgICAgICAgIHJvd0lkcy5wdXNoKG91dEJpbmRzW2luZGV4ICsgb2Zmc2V0XSk7XG4gICAgICAgICAgICAgIGJpbmRSZXNvbHZlcigpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgb2JqLnJlc3BvbnNlW2xpbmVdID0gb2JqLnJlc3BvbnNlW2xpbmVdIHx8IHt9O1xuICAgICAgICAgICAgICBvYmoucmVzcG9uc2VbbGluZV1bb3V0XSA9IG91dEJpbmRzW2luZGV4ICsgb2Zmc2V0XTtcbiAgICAgICAgICAgICAgYmluZFJlc29sdmVyKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb24uY29tbWl0QXN5bmMoKTtcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmIChvYmoucmV0dXJuaW5nU3FsKSB7XG4gICAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb24uZXhlY3V0ZUFzeW5jKG9iai5yZXR1cm5pbmdTcWwoKSwgcm93SWRzLCB7cmVzdWx0U2V0OiB0cnVlfSlcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgIG9iai5yZXNwb25zZSA9IHJlc3BvbnNlLnJvd3M7XG4gICAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgICB9LCByZWplY3Rlcik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG9iajtcbiAgICAgIH0sIHJlamVjdGVyKVxuICAgICAgICAudGhlbihmdW5jdGlvbihvYmopIHtcbiAgICAgICAgICByZXNvbHZlcihvYmopO1xuICAgICAgICB9KTtcbiAgICB9LCByZWplY3Rlcik7XG4gIH0pO1xufTtcblxuLy8gSGFuZGxlIGNsb2JcbmZ1bmN0aW9uIHJlYWRTdHJlYW0oc3RyZWFtLCBjYikge1xuICBjb25zdCBvcmFjbGVkYiA9IHJlcXVpcmUoJ29yYWNsZWRiJyk7XG4gIGxldCBkYXRhID0gJyc7XG5cbiAgaWYgKHN0cmVhbS5pTG9iLnR5cGUgPT09IG9yYWNsZWRiLkNMT0IpIHtcbiAgICBzdHJlYW0uc2V0RW5jb2RpbmcoJ3V0Zi04Jyk7XG4gIH0gZWxzZSB7XG4gICAgZGF0YSA9IG5ldyBCdWZmZXIoMCk7XG4gIH1cbiAgc3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikge1xuICAgIGNiKGVycik7XG4gIH0pO1xuICBzdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykge1xuICAgIGlmIChzdHJlYW0uaUxvYi50eXBlID09PSBvcmFjbGVkYi5DTE9CKSB7XG4gICAgICBkYXRhICs9IGNodW5rO1xuICAgIH0gZWxzZSB7XG4gICAgICBkYXRhID0gQnVmZmVyLmNvbmNhdChbZGF0YSwgY2h1bmtdKTtcbiAgICB9XG4gIH0pO1xuICBzdHJlYW0ub24oJ2VuZCcsIGZ1bmN0aW9uKCkge1xuICAgIGNiKG51bGwsIGRhdGEpO1xuICB9KTtcbn1cblxuLy8gUHJvY2VzcyB0aGUgcmVzcG9uc2UgYXMgcmV0dXJuZWQgZnJvbSB0aGUgcXVlcnkuXG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLnByb2Nlc3NSZXNwb25zZSA9IGZ1bmN0aW9uKG9iaiwgcnVubmVyKSB7XG4gIGxldCByZXNwb25zZSA9IG9iai5yZXNwb25zZTtcbiAgY29uc3QgbWV0aG9kID0gb2JqLm1ldGhvZDtcbiAgaWYgKG9iai5vdXRwdXQpIHtcbiAgICByZXR1cm4gb2JqLm91dHB1dC5jYWxsKHJ1bm5lciwgcmVzcG9uc2UpO1xuICB9XG4gIHN3aXRjaCAobWV0aG9kKSB7XG4gICAgY2FzZSAnc2VsZWN0JzpcbiAgICBjYXNlICdwbHVjayc6XG4gICAgY2FzZSAnZmlyc3QnOlxuICAgICAgcmVzcG9uc2UgPSBoZWxwZXJzLnNraW0ocmVzcG9uc2UpO1xuICAgICAgaWYgKG9iai5tZXRob2QgPT09ICdwbHVjaycpXG4gICAgICAgIHJlc3BvbnNlID0gXy5wbHVjayhyZXNwb25zZSwgb2JqLnBsdWNrKTtcbiAgICAgIHJldHVybiBvYmoubWV0aG9kID09PSAnZmlyc3QnID8gcmVzcG9uc2VbMF0gOiByZXNwb25zZTtcbiAgICBjYXNlICdpbnNlcnQnOlxuICAgIGNhc2UgJ2RlbCc6XG4gICAgY2FzZSAndXBkYXRlJzpcbiAgICBjYXNlICdjb3VudGVyJzpcbiAgICAgIGlmIChvYmoucmV0dXJuaW5nKSB7XG4gICAgICAgIGlmIChvYmoucmV0dXJuaW5nLmxlbmd0aCA9PT0gMSAmJiBvYmoucmV0dXJuaW5nWzBdICE9PSAnKicpIHtcbiAgICAgICAgICByZXR1cm4gXy5mbGF0dGVuKF8ubWFwKHJlc3BvbnNlLCBfLnZhbHVlcykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgIH0gZWxzZSBpZiAoIV8uaXNVbmRlZmluZWQob2JqLnJvd3NBZmZlY3RlZCkpIHtcbiAgICAgICAgcmV0dXJuIG9iai5yb3dzQWZmZWN0ZWQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gMTtcbiAgICAgIH1cbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IENsaWVudF9PcmFjbGVkYjtcbiJdfQ==