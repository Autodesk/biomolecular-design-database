'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var Oracle_Compiler = require('../../oracle/query/compiler');
var ReturningHelper = require('../utils').ReturningHelper;
var BlobHelper = require('../utils').BlobHelper;

function Oracledb_Compiler(client, builder) {
  Oracle_Compiler.call(this, client, builder);
}
inherits(Oracledb_Compiler, Oracle_Compiler);

_.assign(Oracledb_Compiler.prototype, {
  // Compiles an "insert" query, allowing for multiple
  // inserts using a single query statement.
  insert: function insert() {
    var self = this;
    var outBindPrep = this._prepOutbindings(this.single.insert, this.single.returning);
    var outBinding = outBindPrep.outBinding;
    var returning = outBindPrep.returning;
    var insertValues = outBindPrep.values;

    if (Array.isArray(insertValues) && insertValues.length === 1 && _.isEmpty(insertValues[0])) {
      return this._addReturningToSqlAndConvert('insert into ' + this.tableName + ' (' + this.formatter.wrap(this.single.returning) + ') values (default)', outBinding[0], this.tableName, returning);
    }

    if (_.isEmpty(this.single.insert) && typeof this.single.insert !== 'function') {
      return '';
    }

    var insertData = this._prepInsert(insertValues);

    var sql = {};

    if (_.isString(insertData)) {
      return this._addReturningToSqlAndConvert('insert into ' + this.tableName + ' ' + insertData, outBinding[0], this.tableName, returning);
    }

    if (insertData.values.length === 1) {
      return this._addReturningToSqlAndConvert('insert into ' + this.tableName + ' (' + this.formatter.columnize(insertData.columns) + ') values (' + this.formatter.parameterize(insertData.values[0]) + ')', outBinding[0], this.tableName, returning);
    }

    var insertDefaultsOnly = insertData.columns.length === 0;
    sql.returning = returning;
    sql.sql = 'begin ' + _.map(insertData.values, function (value, index) {
      var parameterizedValues = !insertDefaultsOnly ? self.formatter.parameterize(value, self.client.valueForUndefined) : '';
      var subSql = 'insert into ' + self.tableName;

      if (insertDefaultsOnly) {
        // No columns given so only the default value
        subSql += ' (' + self.formatter.wrap(self.single.returning) + ') values (default)';
      } else {
        subSql += ' (' + self.formatter.columnize(insertData.columns) + ') values (' + parameterizedValues + ')';
      }

      var returningClause = '';
      var intoClause = '';
      var usingClause = '';
      var outClause = '';

      _.each(value, function (val) {
        if (!(val instanceof BlobHelper)) {
          usingClause += ' ?,';
        }
      });
      usingClause = usingClause.slice(0, -1);

      // Build returning and into clauses
      _.each(outBinding[index], function (ret) {
        var columnName = ret.columnName || ret;
        returningClause += '"' + columnName + '",';
        intoClause += ' ?,';
        outClause += ' out ?,';

        // Add Helpers to bindings
        if (ret instanceof BlobHelper) {
          return self.formatter.bindings.push(ret);
        }
        self.formatter.bindings.push(new ReturningHelper(columnName));
      });

      // Strip last comma
      returningClause = returningClause.slice(0, -1);
      intoClause = intoClause.slice(0, -1);
      outClause = outClause.slice(0, -1);

      if (returningClause && intoClause) {
        subSql += ' returning ' + returningClause + ' into' + intoClause;
      }

      // Pre bind position because subSql is an execute immediate parameter
      // later position binding will only convert the ? params
      subSql = self.formatter.client.positionBindings(subSql);
      var parameterizedValuesWithoutDefaultAndBlob = parameterizedValues.replace('DEFAULT, ', '').replace(', DEFAULT', '').replace('EMPTY_BLOB(), ', '').replace(', EMPTY_BLOB()', '');
      return 'execute immediate \'' + subSql.replace(/'/g, "''") + (parameterizedValuesWithoutDefaultAndBlob || value ? '\' using ' : '') + parameterizedValuesWithoutDefaultAndBlob + (parameterizedValuesWithoutDefaultAndBlob && outClause ? ',' : '') + outClause + ';';
    }).join(' ') + 'end;';

    sql.outBinding = outBinding;
    if (returning[0] === '*') {
      returning = returning.slice(0, -1);

      // Generate select statement with special order by
      // to keep the order because 'in (..)' may change the order
      sql.returningSql = function () {
        return 'select * from ' + self.tableName + ' where ROWID in (' + this.outBinding.map(function (v, i) {
          return ':' + (i + 1);
        }).join(', ') + ')' + ' order by case ROWID ' + this.outBinding.map(function (v, i) {
          return 'when CHARTOROWID(:' + (i + 1) + ') then ' + i;
        }).join(' ') + ' end';
      };
    }

    return sql;
  },

  _addReturningToSqlAndConvert: function _addReturningToSqlAndConvert(sql, outBinding, tableName, returning) {
    var self = this;
    var res = {
      sql: sql
    };

    if (!outBinding) {
      return res;
    }
    var returningValues = Array.isArray(outBinding) ? outBinding : [outBinding];
    var returningClause = '';
    var intoClause = '';
    // Build returning and into clauses
    _.each(returningValues, function (ret) {
      var columnName = ret.columnName || ret;
      returningClause += '"' + columnName + '",';
      intoClause += '?,';

      // Add Helpers to bindings
      if (ret instanceof BlobHelper) {
        return self.formatter.bindings.push(ret);
      }
      self.formatter.bindings.push(new ReturningHelper(columnName));
    });
    res.sql = sql;

    // Strip last comma
    returningClause = returningClause.slice(0, -1);
    intoClause = intoClause.slice(0, -1);
    if (returningClause && intoClause) {
      res.sql += ' returning ' + returningClause + ' into ' + intoClause;
    }
    res.outBinding = [outBinding];
    if (returning[0] === '*') {
      res.returningSql = function () {
        return 'select * from ' + self.tableName + ' where ROWID = :1';
      };
    }
    res.returning = returning;

    return res;
  },

  _prepOutbindings: function _prepOutbindings(paramValues, paramReturning) {
    var result = {};
    var params = paramValues || [];
    var returning = paramReturning || [];
    if (!Array.isArray(params) && _.isPlainObject(paramValues)) {
      params = [params];
    }
    // Always wrap returning argument in array
    if (returning && !Array.isArray(returning)) {
      returning = [returning];
    }

    var outBinding = [];
    // Handle Buffer value as Blob
    _.each(params, function (values, index) {
      if (returning[0] === '*') {
        outBinding[index] = ['ROWID'];
      } else {
        outBinding[index] = _.clone(returning);
      }
      _.each(values, function (value, key) {
        if (value instanceof Buffer) {
          values[key] = new BlobHelper(key, value);

          // Delete blob duplicate in returning
          var blobIndex = outBinding[index].indexOf(key);
          if (blobIndex >= 0) {
            outBinding[index].splice(blobIndex, 1);
            values[key].returning = true;
          }
          outBinding[index].push(values[key]);
        }
      });
    });
    result.returning = returning;
    result.outBinding = outBinding;
    result.values = params;
    return result;
  },

  update: function update() {
    var self = this;
    var sql = {};
    var outBindPrep = this._prepOutbindings(this.single.update, this.single.returning);
    var outBinding = outBindPrep.outBinding;
    var returning = outBindPrep.returning;

    var updates = this._prepUpdate(this.single.update);
    var where = this.where();

    var returningClause = '';
    var intoClause = '';

    if (_.isEmpty(this.single.update) && typeof this.single.update !== 'function') {
      return '';
    }

    // Build returning and into clauses
    _.each(outBinding, function (out) {
      _.each(out, function (ret) {
        var columnName = ret.columnName || ret;
        returningClause += '"' + columnName + '",';
        intoClause += ' ?,';

        // Add Helpers to bindings
        if (ret instanceof BlobHelper) {
          return self.formatter.bindings.push(ret);
        }
        self.formatter.bindings.push(new ReturningHelper(columnName));
      });
    });
    // Strip last comma
    returningClause = returningClause.slice(0, -1);
    intoClause = intoClause.slice(0, -1);

    sql.outBinding = outBinding;
    sql.returning = returning;
    sql.sql = 'update ' + this.tableName + ' set ' + updates.join(', ') + (where ? ' ' + where : '');
    if (outBinding.length && !_.isEmpty(outBinding[0])) {
      sql.sql += ' returning ' + returningClause + ' into' + intoClause;
    }
    if (returning[0] === '*') {

      sql.returningSql = function () {

        var sql = 'select * from ' + self.tableName;
        var modifiedRowsCount = this.rowsAffected.length || this.rowsAffected;
        var returningSqlIn = ' where ROWID in (';
        var returningSqlOrderBy = ') order by case ROWID ';

        // Needs special order by because in(...) change result order
        for (var i = 0; i < modifiedRowsCount; i++) {
          if (this.returning[0] === '*') {
            returningSqlIn += ':' + (i + 1) + ', ';
            returningSqlOrderBy += 'when CHARTOROWID(:' + (i + 1) + ') then ' + i + ' ';
          }
        }
        if (this.returning[0] === '*') {
          this.returning = this.returning.slice(0, -1);
          returningSqlIn = returningSqlIn.slice(0, -2);
          returningSqlOrderBy = returningSqlOrderBy.slice(0, -1);
        }
        return sql += returningSqlIn + returningSqlOrderBy + ' end';
      };
    }

    return sql;
  }

});

module.exports = Oracledb_Compiler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9vcmFjbGVkYi9xdWVyeS9jb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQU0sQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUM1QixJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDckMsSUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLDZCQUE2QixDQUFDLENBQUM7QUFDL0QsSUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLGVBQWUsQ0FBQztBQUM1RCxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsVUFBVSxDQUFDOztBQUVsRCxTQUFTLGlCQUFpQixDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUU7QUFDMUMsaUJBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztDQUM3QztBQUNELFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxlQUFlLENBQUMsQ0FBQzs7QUFFN0MsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLEVBQUU7OztBQUdwQyxRQUFNLEVBQUUsa0JBQVc7QUFDakIsUUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ2xCLFFBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3JGLFFBQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUM7QUFDMUMsUUFBSSxTQUFTLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQztBQUN0QyxRQUFNLFlBQVksR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDOztBQUV4QyxRQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksWUFBWSxDQUFD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aUIsQ0FBQyIsImZpbGUiOiJjb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTtcbmNvbnN0IE9yYWNsZV9Db21waWxlciA9IHJlcXVpcmUoJy4uLy4uL29yYWNsZS9xdWVyeS9jb21waWxlcicpO1xuY29uc3QgUmV0dXJuaW5nSGVscGVyID0gcmVxdWlyZSgnLi4vdXRpbHMnKS5SZXR1cm5pbmdIZWxwZXI7XG5jb25zdCBCbG9iSGVscGVyID0gcmVxdWlyZSgnLi4vdXRpbHMnKS5CbG9iSGVscGVyO1xuXG5mdW5jdGlvbiBPcmFjbGVkYl9Db21waWxlcihjbGllbnQsIGJ1aWxkZXIpIHtcbiAgT3JhY2xlX0NvbXBpbGVyLmNhbGwodGhpcywgY2xpZW50LCBidWlsZGVyKTtcbn1cbmluaGVyaXRzKE9yYWNsZWRiX0NvbXBpbGVyLCBPcmFjbGVfQ29tcGlsZXIpO1xuXG5fLmFzc2lnbihPcmFjbGVkYl9Db21waWxlci5wcm90b3R5cGUsIHtcbiAgLy8gQ29tcGlsZXMgYW4gXCJpbnNlcnRcIiBxdWVyeSwgYWxsb3dpbmcgZm9yIG11bHRpcGxlXG4gIC8vIGluc2VydHMgdXNpbmcgYSBzaW5nbGUgcXVlcnkgc3RhdGVtZW50LlxuICBpbnNlcnQ6IGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIGNvbnN0IG91dEJpbmRQcmVwID0gdGhpcy5fcHJlcE91dGJpbmRpbmdzKHRoaXMuc2luZ2xlLmluc2VydCwgdGhpcy5zaW5nbGUucmV0dXJuaW5nKTtcbiAgICBjb25zdCBvdXRCaW5kaW5nID0gb3V0QmluZFByZXAub3V0QmluZGluZztcbiAgICBsZXQgcmV0dXJuaW5nID0gb3V0QmluZFByZXAucmV0dXJuaW5nO1xuICAgIGNvbnN0IGluc2VydFZhbHVlcyA9IG91dEJpbmRQcmVwLnZhbHVlcztcblxuICAgIGlmIChBcnJheS5pc0FycmF5KGluc2VydFZhbHVlcykgJiYgaW5zZXJ0VmFsdWVzLmxlbmd0aCA9PT0gMSAmJiBfLmlzRW1wdHkoaW5zZXJ0VmFsdWVzWzBdKSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2FkZFJldHVybmluZ1RvU3FsQW5kQ29udmVydCgnaW5zZXJ0IGludG8gJyArXG4gICAgICAgIHRoaXMudGFibGVOYW1lICtcbiAgICAgICAgJyAoJyArIHRoaXMuZm9ybWF0dGVyLndyYXAodGhpcy5zaW5nbGUucmV0dXJuaW5nKSArICcpIHZhbHVlcyAoZGVmYXVsdCknLFxuICAgICAgICBvdXRCaW5kaW5nWzBdLCB0aGlzLnRhYmxlTmFtZSwgcmV0dXJuaW5nKTtcbiAgICB9XG5cbiAgICBpZiAoXy5pc0VtcHR5KHRoaXMuc2luZ2xlLmluc2VydCkgJiYgdHlwZW9mIHRoaXMuc2luZ2xlLmluc2VydCAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIGNvbnN0IGluc2VydERhdGEgPSB0aGlzLl9wcmVwSW5zZXJ0KGluc2VydFZhbHVlcyk7XG5cbiAgICBjb25zdCBzcWwgPSB7fTtcblxuICAgIGlmIChfLmlzU3RyaW5nKGluc2VydERhdGEpKSB7XG4gICAgICByZXR1cm4gdGhpcy5fYWRkUmV0dXJuaW5nVG9TcWxBbmRDb252ZXJ0KCdpbnNlcnQgaW50byAnICtcbiAgICAgICAgdGhpcy50YWJsZU5hbWUgKyAnICcgKyBpbnNlcnREYXRhLCBvdXRCaW5kaW5nWzBdLFxuICAgICAgICB0aGlzLnRhYmxlTmFtZSwgcmV0dXJuaW5nKTtcbiAgICB9XG5cbiAgICBpZiAoaW5zZXJ0RGF0YS52YWx1ZXMubGVuZ3RoID09PSAxKSB7XG4gICAgICByZXR1cm4gdGhpcy5fYWRkUmV0dXJuaW5nVG9TcWxBbmRDb252ZXJ0KCdpbnNlcnQgaW50byAnICtcbiAgICAgICAgdGhpcy50YWJsZU5hbWUgKyAnICgnICsgdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGluc2VydERhdGEuY29sdW1ucykgK1xuICAgICAgICAnKSB2YWx1ZXMgKCcgKyB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXJpemUoaW5zZXJ0RGF0YS52YWx1ZXNbMF0pICsgJyknLFxuICAgICAgICBvdXRCaW5kaW5nWzBdLCB0aGlzLnRhYmxlTmFtZSwgcmV0dXJuaW5nKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnNlcnREZWZhdWx0c09ubHkgPSAoaW5zZXJ0RGF0YS5jb2x1bW5zLmxlbmd0aCA9PT0gMCk7XG4gICAgc3FsLnJldHVybmluZyA9IHJldHVybmluZztcbiAgICBzcWwuc3FsID0gJ2JlZ2luICcgK1xuICAgICAgXy5tYXAoaW5zZXJ0RGF0YS52YWx1ZXMsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkge1xuICAgICAgICBjb25zdCBwYXJhbWV0ZXJpemVkVmFsdWVzID0gIWluc2VydERlZmF1bHRzT25seSA/XG4gICAgICAgICAgc2VsZi5mb3JtYXR0ZXIucGFyYW1ldGVyaXplKHZhbHVlLCBzZWxmLmNsaWVudC52YWx1ZUZvclVuZGVmaW5lZCkgOlxuICAgICAgICAgICcnO1xuICAgICAgICBsZXQgc3ViU3FsID0gJ2luc2VydCBpbnRvICcgKyBzZWxmLnRhYmxlTmFtZTtcblxuICAgICAgICBpZiAoaW5zZXJ0RGVmYXVsdHNPbmx5KSB7XG4gICAgICAgICAgLy8gTm8gY29sdW1ucyBnaXZlbiBzbyBvbmx5IHRoZSBkZWZhdWx0IHZhbHVlXG4gICAgICAgICAgc3ViU3FsICs9ICcgKCcgKyBzZWxmLmZvcm1hdHRlci53cmFwKHNlbGYuc2luZ2xlLnJldHVybmluZykgKyAnKSB2YWx1ZXMgKGRlZmF1bHQpJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzdWJTcWwgKz0gJyAoJyArXG4gICAgICAgICAgICBzZWxmLmZvcm1hdHRlci5jb2x1bW5pemUoaW5zZXJ0RGF0YS5jb2x1bW5zKSArXG4gICAgICAgICAgICAnKSB2YWx1ZXMgKCcgKyBwYXJhbWV0ZXJpemVkVmFsdWVzICsgJyknO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHJldHVybmluZ0NsYXVzZSA9ICcnO1xuICAgICAgICBsZXQgaW50b0NsYXVzZSA9ICcnO1xuICAgICAgICBsZXQgdXNpbmdDbGF1c2UgPSAnJztcbiAgICAgICAgbGV0IG91dENsYXVzZSA9ICcnO1xuXG4gICAgICAgIF8uZWFjaCh2YWx1ZSwgZnVuY3Rpb24odmFsKSB7XG4gICAgICAgICAgaWYgKCEodmFsIGluc3RhbmNlb2YgQmxvYkhlbHBlcikpIHtcbiAgICAgICAgICAgIHVzaW5nQ2xhdXNlICs9ICcgPywnO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHVzaW5nQ2xhdXNlID0gdXNpbmdDbGF1c2Uuc2xpY2UoMCwgLTEpO1xuXG4gICAgICAgIC8vIEJ1aWxkIHJldHVybmluZyBhbmQgaW50byBjbGF1c2VzXG4gICAgICAgIF8uZWFjaChvdXRCaW5kaW5nW2luZGV4XSwgZnVuY3Rpb24ocmV0KSB7XG4gICAgICAgICAgY29uc3QgY29sdW1uTmFtZSA9IHJldC5jb2x1bW5OYW1lIHx8IHJldDtcbiAgICAgICAgICByZXR1cm5pbmdDbGF1c2UgKz0gJ1wiJyArIGNvbHVtbk5hbWUgKyAnXCIsJztcbiAgICAgICAgICBpbnRvQ2xhdXNlICs9ICcgPywnO1xuICAgICAgICAgIG91dENsYXVzZSArPSAnIG91dCA/LCc7XG5cbiAgICAgICAgICAvLyBBZGQgSGVscGVycyB0byBiaW5kaW5nc1xuICAgICAgICAgIGlmIChyZXQgaW5zdGFuY2VvZiBCbG9iSGVscGVyKSB7XG4gICAgICAgICAgICByZXR1cm4gc2VsZi5mb3JtYXR0ZXIuYmluZGluZ3MucHVzaChyZXQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBzZWxmLmZvcm1hdHRlci5iaW5kaW5ncy5wdXNoKG5ldyBSZXR1cm5pbmdIZWxwZXIoY29sdW1uTmFtZSkpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBTdHJpcCBsYXN0IGNvbW1hXG4gICAgICAgIHJldHVybmluZ0NsYXVzZSA9IHJldHVybmluZ0NsYXVzZS5zbGljZSgwLCAtMSk7XG4gICAgICAgIGludG9DbGF1c2UgPSBpbnRvQ2xhdXNlLnNsaWNlKDAsIC0xKTtcbiAgICAgICAgb3V0Q2xhdXNlID0gb3V0Q2xhdXNlLnNsaWNlKDAsIC0xKTtcblxuICAgICAgICBpZiAocmV0dXJuaW5nQ2xhdXNlICYmIGludG9DbGF1c2UpIHtcbiAgICAgICAgICBzdWJTcWwgKz0gJyByZXR1cm5pbmcgJyArIHJldHVybmluZ0NsYXVzZSArICcgaW50bycgKyBpbnRvQ2xhdXNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gUHJlIGJpbmQgcG9zaXRpb24gYmVjYXVzZSBzdWJTcWwgaXMgYW4gZXhlY3V0ZSBpbW1lZGlhdGUgcGFyYW1ldGVyXG4gICAgICAgIC8vIGxhdGVyIHBvc2l0aW9uIGJpbmRpbmcgd2lsbCBvbmx5IGNvbnZlcnQgdGhlID8gcGFyYW1zXG4gICAgICAgIHN1YlNxbCA9IHNlbGYuZm9ybWF0dGVyLmNsaWVudC5wb3NpdGlvbkJpbmRpbmdzKHN1YlNxbCk7XG4gICAgICAgIGNvbnN0IHBhcmFtZXRlcml6ZWRWYWx1ZXNXaXRob3V0RGVmYXVsdEFuZEJsb2IgPSBwYXJhbWV0ZXJpemVkVmFsdWVzXG4gICAgICAgICAgLnJlcGxhY2UoJ0RFRkFVTFQsICcsICcnKVxuICAgICAgICAgIC5yZXBsYWNlKCcsIERFRkFVTFQnLCAnJylcbiAgICAgICAgICAucmVwbGFjZSgnRU1QVFlfQkxPQigpLCAnLCAnJylcbiAgICAgICAgICAucmVwbGFjZSgnLCBFTVBUWV9CTE9CKCknLCAnJyk7XG4gICAgICAgIHJldHVybidleGVjdXRlIGltbWVkaWF0ZSBcXCcnICsgc3ViU3FsLnJlcGxhY2UoLycvZywgXCInJ1wiKSArXG4gICAgICAgICAgKChwYXJhbWV0ZXJpemVkVmFsdWVzV2l0aG91dERlZmF1bHRBbmRCbG9iIHx8IHZhbHVlKSA/XG4gICAgICAgICAgICAnXFwnIHVzaW5nICcgOlxuICAgICAgICAgICAgJycpICtcbiAgICAgICAgICBwYXJhbWV0ZXJpemVkVmFsdWVzV2l0aG91dERlZmF1bHRBbmRCbG9iICtcbiAgICAgICAgICAoKHBhcmFtZXRlcml6ZWRWYWx1ZXNXaXRob3V0RGVmYXVsdEFuZEJsb2IgJiYgb3V0Q2xhdXNlKSA/XG4gICAgICAgICAgICAnLCcgOlxuICAgICAgICAgICAgJycpICtcbiAgICAgICAgICBvdXRDbGF1c2UgKyAnOyc7XG4gICAgICB9KS5qb2luKCcgJykgKyAnZW5kOyc7XG5cbiAgICBzcWwub3V0QmluZGluZyA9IG91dEJpbmRpbmc7XG4gICAgaWYgKHJldHVybmluZ1swXSA9PT0gJyonKSB7XG4gICAgICByZXR1cm5pbmcgPSByZXR1cm5pbmcuc2xpY2UoMCwgLTEpO1xuXG4gICAgICAvLyBHZW5lcmF0ZSBzZWxlY3Qgc3RhdGVtZW50IHdpdGggc3BlY2lhbCBvcmRlciBieVxuICAgICAgLy8gdG8ga2VlcCB0aGUgb3JkZXIgYmVjYXVzZSAnaW4gKC4uKScgbWF5IGNoYW5nZSB0aGUgb3JkZXJcbiAgICAgIHNxbC5yZXR1cm5pbmdTcWwgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuICdzZWxlY3QgKiBmcm9tICcgKyBzZWxmLnRhYmxlTmFtZSArXG4gICAgICAgICcgd2hlcmUgUk9XSUQgaW4gKCcgKyB0aGlzLm91dEJpbmRpbmcubWFwKGZ1bmN0aW9uKHYsIGkpIHtcbiAgICAgICAgICByZXR1cm4gJzonICsgKGkgKyAxKTtcbiAgICAgICAgfSkuam9pbignLCAnKSArICcpJyArXG4gICAgICAgICcgb3JkZXIgYnkgY2FzZSBST1dJRCAnICsgdGhpcy5vdXRCaW5kaW5nLm1hcChmdW5jdGlvbih2LCBpKSB7XG4gICAgICAgICAgcmV0dXJuICd3aGVuIENIQVJUT1JPV0lEKDonICsgKGkgKyAxKSArICcpIHRoZW4gJyArIGk7XG4gICAgICAgIH0pLmpvaW4oJyAnKSArICcgZW5kJztcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHNxbDtcbiAgfSxcblxuICBfYWRkUmV0dXJuaW5nVG9TcWxBbmRDb252ZXJ0OiBmdW5jdGlvbihzcWwsIG91dEJpbmRpbmcsIHRhYmxlTmFtZSwgcmV0dXJuaW5nKSB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgY29uc3QgcmVzID0ge1xuICAgICAgc3FsOiBzcWxcbiAgICB9O1xuXG4gICAgaWYgKCFvdXRCaW5kaW5nKSB7XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH1cbiAgICBjb25zdCByZXR1cm5pbmdWYWx1ZXMgPSBBcnJheS5pc0FycmF5KG91dEJpbmRpbmcpID8gb3V0QmluZGluZyA6IFtvdXRCaW5kaW5nXTtcbiAgICBsZXQgcmV0dXJuaW5nQ2xhdXNlID0gJyc7XG4gICAgbGV0IGludG9DbGF1c2UgPSAnJztcbiAgICAvLyBCdWlsZCByZXR1cm5pbmcgYW5kIGludG8gY2xhdXNlc1xuICAgIF8uZWFjaChyZXR1cm5pbmdWYWx1ZXMsIGZ1bmN0aW9uKHJldCkge1xuICAgICAgY29uc3QgY29sdW1uTmFtZSA9IHJldC5jb2x1bW5OYW1lIHx8IHJldDtcbiAgICAgIHJldHVybmluZ0NsYXVzZSArPSAnXCInICsgY29sdW1uTmFtZSArICdcIiwnO1xuICAgICAgaW50b0NsYXVzZSArPSAnPywnO1xuXG4gICAgICAvLyBBZGQgSGVscGVycyB0byBiaW5kaW5nc1xuICAgICAgaWYgKHJldCBpbnN0YW5jZW9mIEJsb2JIZWxwZXIpIHtcbiAgICAgICAgcmV0dXJuIHNlbGYuZm9ybWF0dGVyLmJpbmRpbmdzLnB1c2gocmV0KTtcbiAgICAgIH1cbiAgICAgIHNlbGYuZm9ybWF0dGVyLmJpbmRpbmdzLnB1c2gobmV3IFJldHVybmluZ0hlbHBlcihjb2x1bW5OYW1lKSk7XG4gICAgfSk7XG4gICAgcmVzLnNxbCA9IHNxbDtcblxuICAgIC8vIFN0cmlwIGxhc3QgY29tbWFcbiAgICByZXR1cm5pbmdDbGF1c2UgPSByZXR1cm5pbmdDbGF1c2Uuc2xpY2UoMCwgLTEpO1xuICAgIGludG9DbGF1c2UgPSBpbnRvQ2xhdXNlLnNsaWNlKDAsIC0xKTtcbiAgICBpZiAocmV0dXJuaW5nQ2xhdXNlICYmIGludG9DbGF1c2UpIHtcbiAgICAgIHJlcy5zcWwgKz0gJyByZXR1cm5pbmcgJyArIHJldHVybmluZ0NsYXVzZSArICcgaW50byAnICsgaW50b0NsYXVzZTtcbiAgICB9XG4gICAgcmVzLm91dEJpbmRpbmcgPSBbb3V0QmluZGluZ107XG4gICAgaWYocmV0dXJuaW5nWzBdID09PSAnKicpIHtcbiAgICAgIHJlcy5yZXR1cm5pbmdTcWwgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuICdzZWxlY3QgKiBmcm9tICcgKyBzZWxmLnRhYmxlTmFtZSArICcgd2hlcmUgUk9XSUQgPSA6MSc7XG4gICAgICB9O1xuICAgIH1cbiAgICByZXMucmV0dXJuaW5nID0gcmV0dXJuaW5nO1xuXG4gICAgcmV0dXJuIHJlcztcbiAgfSxcblxuICBfcHJlcE91dGJpbmRpbmdzOiBmdW5jdGlvbihwYXJhbVZhbHVlcywgcGFyYW1SZXR1cm5pbmcpIHtcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICBsZXQgcGFyYW1zID0gcGFyYW1WYWx1ZXMgfHwgW107XG4gICAgbGV0IHJldHVybmluZyA9IHBhcmFtUmV0dXJuaW5nIHx8IFtdO1xuICAgIGlmICghQXJyYXkuaXNBcnJheShwYXJhbXMpICYmIF8uaXNQbGFpbk9iamVjdChwYXJhbVZhbHVlcykpIHtcbiAgICAgIHBhcmFtcyA9IFtwYXJhbXNdO1xuICAgIH1cbiAgICAvLyBBbHdheXMgd3JhcCByZXR1cm5pbmcgYXJndW1lbnQgaW4gYXJyYXlcbiAgICBpZiAocmV0dXJuaW5nICYmICFBcnJheS5pc0FycmF5KHJldHVybmluZykpIHtcbiAgICAgIHJldHVybmluZyA9IFtyZXR1cm5pbmddO1xuICAgIH1cblxuICAgIGNvbnN0IG91dEJpbmRpbmcgPSBbXTtcbiAgICAvLyBIYW5kbGUgQnVmZmVyIHZhbHVlIGFzIEJsb2JcbiAgICBfLmVhY2gocGFyYW1zLCBmdW5jdGlvbih2YWx1ZXMsIGluZGV4KSB7XG4gICAgICBpZiAocmV0dXJuaW5nWzBdID09PSAnKicpIHtcbiAgICAgICAgb3V0QmluZGluZ1tpbmRleF0gPSBbJ1JPV0lEJ107XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRCaW5kaW5nW2luZGV4XSA9IF8uY2xvbmUocmV0dXJuaW5nKTtcbiAgICAgIH1cbiAgICAgIF8uZWFjaCh2YWx1ZXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHtcbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQnVmZmVyKSB7XG4gICAgICAgICAgdmFsdWVzW2tleV0gPSBuZXcgQmxvYkhlbHBlcihrZXksIHZhbHVlKTtcblxuICAgICAgICAgIC8vIERlbGV0ZSBibG9iIGR1cGxpY2F0ZSBpbiByZXR1cm5pbmdcbiAgICAgICAgICBjb25zdCBibG9iSW5kZXggPSBvdXRCaW5kaW5nW2luZGV4XS5pbmRleE9mKGtleSk7XG4gICAgICAgICAgaWYgKGJsb2JJbmRleCA+PSAwKSB7XG4gICAgICAgICAgICBvdXRCaW5kaW5nW2luZGV4XS5zcGxpY2UoYmxvYkluZGV4LCAxKTtcbiAgICAgICAgICAgIHZhbHVlc1trZXldLnJldHVybmluZyA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIG91dEJpbmRpbmdbaW5kZXhdLnB1c2godmFsdWVzW2tleV0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXN1bHQucmV0dXJuaW5nID0gcmV0dXJuaW5nO1xuICAgIHJlc3VsdC5vdXRCaW5kaW5nID0gb3V0QmluZGluZztcbiAgICByZXN1bHQudmFsdWVzID0gcGFyYW1zO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH0sXG5cbiAgdXBkYXRlOiBmdW5jdGlvbigpIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICBjb25zdCBzcWwgPSB7fTtcbiAgICBjb25zdCBvdXRCaW5kUHJlcCA9IHRoaXMuX3ByZXBPdXRiaW5kaW5ncyh0aGlzLnNpbmdsZS51cGRhdGUsIHRoaXMuc2luZ2xlLnJldHVybmluZyk7XG4gICAgY29uc3Qgb3V0QmluZGluZyA9IG91dEJpbmRQcmVwLm91dEJpbmRpbmc7XG4gICAgY29uc3QgcmV0dXJuaW5nID0gb3V0QmluZFByZXAucmV0dXJuaW5nO1xuXG4gICAgY29uc3QgdXBkYXRlcyA9IHRoaXMuX3ByZXBVcGRhdGUodGhpcy5zaW5nbGUudXBkYXRlKTtcbiAgICBjb25zdCB3aGVyZSA9IHRoaXMud2hlcmUoKTtcblxuICAgIGxldCByZXR1cm5pbmdDbGF1c2UgPSAnJztcbiAgICBsZXQgaW50b0NsYXVzZSA9ICcnO1xuXG4gICAgaWYgKF8uaXNFbXB0eSh0aGlzLnNpbmdsZS51cGRhdGUpICYmIHR5cGVvZiB0aGlzLnNpbmdsZS51cGRhdGUgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG5cbiAgICAvLyBCdWlsZCByZXR1cm5pbmcgYW5kIGludG8gY2xhdXNlc1xuICAgIF8uZWFjaChvdXRCaW5kaW5nLCBmdW5jdGlvbihvdXQpIHtcbiAgICAgIF8uZWFjaChvdXQsIGZ1bmN0aW9uKHJldCkge1xuICAgICAgICBjb25zdCBjb2x1bW5OYW1lID0gcmV0LmNvbHVtbk5hbWUgfHwgcmV0O1xuICAgICAgICByZXR1cm5pbmdDbGF1c2UgKz0gJ1wiJyArIGNvbHVtbk5hbWUgKyAnXCIsJztcbiAgICAgICAgaW50b0NsYXVzZSArPSAnID8sJztcblxuICAgICAgICAvLyBBZGQgSGVscGVycyB0byBiaW5kaW5nc1xuICAgICAgICBpZiAocmV0IGluc3RhbmNlb2YgQmxvYkhlbHBlcikge1xuICAgICAgICAgIHJldHVybiBzZWxmLmZvcm1hdHRlci5iaW5kaW5ncy5wdXNoKHJldCk7XG4gICAgICAgIH1cbiAgICAgICAgc2VsZi5mb3JtYXR0ZXIuYmluZGluZ3MucHVzaChuZXcgUmV0dXJuaW5nSGVscGVyKGNvbHVtbk5hbWUpKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIC8vIFN0cmlwIGxhc3QgY29tbWFcbiAgICByZXR1cm5pbmdDbGF1c2UgPSByZXR1cm5pbmdDbGF1c2Uuc2xpY2UoMCwgLTEpO1xuICAgIGludG9DbGF1c2UgPSBpbnRvQ2xhdXNlLnNsaWNlKDAsIC0xKTtcblxuICAgIHNxbC5vdXRCaW5kaW5nID0gb3V0QmluZGluZztcbiAgICBzcWwucmV0dXJuaW5nID0gcmV0dXJuaW5nO1xuICAgIHNxbC5zcWwgPSAndXBkYXRlICcgK1xuICAgICAgdGhpcy50YWJsZU5hbWUgK1xuICAgICAgJyBzZXQgJyArIHVwZGF0ZXMuam9pbignLCAnKSArICh3aGVyZSA/ICcgJyArIHdoZXJlIDogJycpO1xuICAgIGlmKG91dEJpbmRpbmcubGVuZ3RoICYmICFfLmlzRW1wdHkob3V0QmluZGluZ1swXSkpIHtcbiAgICAgIHNxbC5zcWwgKz0gJyByZXR1cm5pbmcgJyArIHJldHVybmluZ0NsYXVzZSArICcgaW50bycgKyBpbnRvQ2xhdXNlO1xuICAgIH1cbiAgICBpZiAocmV0dXJuaW5nWzBdID09PSAnKicpIHtcblxuICAgICAgc3FsLnJldHVybmluZ1NxbCA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgIGxldCBzcWwgPSAnc2VsZWN0ICogZnJvbSAnICsgc2VsZi50YWJsZU5hbWU7XG4gICAgICAgIGNvbnN0IG1vZGlmaWVkUm93c0NvdW50ID0gdGhpcy5yb3dzQWZmZWN0ZWQubGVuZ3RoIHx8IHRoaXMucm93c0FmZmVjdGVkO1xuICAgICAgICBsZXQgcmV0dXJuaW5nU3FsSW4gPSAnIHdoZXJlIFJPV0lEIGluICgnO1xuICAgICAgICBsZXQgcmV0dXJuaW5nU3FsT3JkZXJCeSA9ICcpIG9yZGVyIGJ5IGNhc2UgUk9XSUQgJztcblxuICAgICAgICAvLyBOZWVkcyBzcGVjaWFsIG9yZGVyIGJ5IGJlY2F1c2UgaW4oLi4uKSBjaGFuZ2UgcmVzdWx0IG9yZGVyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbW9kaWZpZWRSb3dzQ291bnQ7IGkrKykge1xuICAgICAgICAgIGlmICh0aGlzLnJldHVybmluZ1swXSA9PT0gJyonKSB7XG4gICAgICAgICAgICByZXR1cm5pbmdTcWxJbiArPSAnOicgKyAoaSArIDEpICsgJywgJztcbiAgICAgICAgICAgIHJldHVybmluZ1NxbE9yZGVyQnkgKz0gJ3doZW4gQ0hBUlRPUk9XSUQoOicgKyAoaSArIDEpICsgJykgdGhlbiAnICsgaSArICcgJztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucmV0dXJuaW5nWzBdID09PSAnKicpIHtcbiAgICAgICAgICB0aGlzLnJldHVybmluZyA9IHRoaXMucmV0dXJuaW5nLnNsaWNlKDAsIC0xKTtcbiAgICAgICAgICByZXR1cm5pbmdTcWxJbiA9IHJldHVybmluZ1NxbEluLnNsaWNlKDAsIC0yKTtcbiAgICAgICAgICByZXR1cm5pbmdTcWxPcmRlckJ5ID0gcmV0dXJuaW5nU3FsT3JkZXJCeS5zbGljZSgwLCAtMSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNxbCArPSByZXR1cm5pbmdTcWxJbiArIHJldHVybmluZ1NxbE9yZGVyQnkgKyAnIGVuZCc7XG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBzcWw7XG4gIH1cblxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gT3JhY2xlZGJfQ29tcGlsZXI7XG4iXX0=